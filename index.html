
<!DOCTYPE html>
<html lang="hi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Shubhzone</title>

    <!-- External Fonts and Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Main App Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Caveat&display=swap"
        rel="stylesheet">

    <style>
        /* ================================================= /
        / === Shubhzone App Styles (Code 2) - FINAL v6.0 === /
        / === MODIFIED AS PER USER REQUEST - AUG 2025    === /
        / === SOLVED: Styles for Reward System & UI/UX   === /
        / ================================================= */

        /* Design Style Guide */
        :root {
            /* Core Color Palette */
            --background: #121212;
            /* Deep Dark Gray/Black */
            --secondary-background: #1A1A1A;
            /* Slightly Lighter Dark Gray for cards, modals */
            --primary-neon: #00FFFF;
            /* Pure Cyan - Your signature Neon color */
            --text-primary: #EEEEEE;
            /* Light Gray for main text */
            --text-secondary: #AAAAAA;
            /* Medium Gray for subheadings, timestamps, helpers */
            --text-disabled: #666666;
            /* Darker Gray for inactive elements */
            --error-red: #FF0000;
            /* Bright Red for danger/errors */
            --success-green: #00FF00;
            /* Bright Green for success */

            /* RGB values for transparent uses in JS or CSS */
            --primary-neon-rgb: 0, 255, 255;
            --background-rgb: 18, 18, 18;
            --secondary-background-rgb: 26, 26, 26;
            --text-primary-rgb: 238, 238, 238;
            --text-secondary-rgb: 170, 170, 170;
            --error-red-rgb: 255, 0, 0;
            --success-green-rgb: 0, 255, 0;

            /* Legacy/Mapped variables (prefer new explicit ones) */
            --dark-grey: var(--secondary-background);
            /* Mapped to secondary background */
            --light-grey: var(--text-secondary);
            /* Mapped to secondary text for general UI use */

        }

        html {
            box-sizing: border-box;
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit;
            /* Apply box-sizing to all elements */
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            width: 100vw;
            min-height: 100vh;
            overflow: hidden;
            overscroll-behavior-y: none;
        }

        .app-container {
            width: 100%;
            height: var(--app-height, 100vh);
            max-width: 420px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            background-color: var(--background);
            isolation: isolate;
            transition: all 0.3s ease-in-out;
        }

        /* ★★★ FIX: फ़ुलस्क्रीन रोटेशन के लिए कंटेनर स्टाइल (REWORKED) ★★★ */
        .app-container.fullscreen-active {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 100vh;
            /* चौड़ाई को स्क्रीन की ऊंचाई के बराबर करें */
            height: 100vw;
            /* ऊंचाई को स्क्रीन की चौड़ाई के बराबर करें */
            max-width: none;
            z-index: 5000;
            border-radius: 0;
            border: none;
            box-shadow: none;
            transform-origin: center center;
            transform: translate(-50%, -50%) rotate(90deg);
            /* बीच में रखकर 90 डिग्री घुमाएं */
        }

        .app-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-image:
                radial-gradient(circle at 20% 30%, var(--primary-neon), transparent 20%),
                radial-gradient(circle at 80% 10%, var(--primary-neon), transparent 20%),
                radial-gradient(circle at 50% 80%, var(--primary-neon), transparent 20%);
            background-repeat: no-repeat;
            opacity: 0.15;
            filter: blur(20px);
            animation: animateParticles 20s linear infinite alternate;
        }

        @keyframes animateParticles {
            from {
                transform: translate(0, 0);
            }

            to {
                transform: translate(20px, -30px) scale(1.2);
            }
        }

        .screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: absolute;
            top: 0;
            left: 0;
            padding: 0;
            box-sizing: border-box;
            opacity: 0;
            pointer-events: none;
            overflow: hidden;
            transform-origin: center center;
            background-color: transparent;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        .screen.active {
            opacity: 1;
            pointer-events: auto;
            z-index: 10;
            transform: none;
        }

        #splash-screen,
        #information-screen {
            padding: 20px;
            background-color: var(--background);
            z-index: 11;
        }

        #information-screen {
            overflow-y: auto;
        }

        #splash-screen {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 40px 20px 20px 20px;
            background-color: var(--background);
            box-sizing: border-box;
            text-align: center;
            overflow: hidden;
            position: relative;
        }

        .welcome-top,
        .welcome-center,
        .welcome-bottom {
            z-index: 2;
            position: relative;
            width: 100%;
        }

        .welcome-top {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .welcome-text {
            font-family: 'Roboto', sans-serif;
            font-size: 3.5em;
            font-weight: 700;
            color: var(--primary-neon);
            text-shadow: 0 0 10px rgba(var(--primary-neon-rgb), 0.5);
            margin: 0;
        }

        .welcome-center {
            flex-grow: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .logo-container {
            width: 150px;
            height: 150px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        @keyframes rotate-gradient {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .logo-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(from 0deg, rgba(var(--primary-neon-rgb), 0.8), transparent, rgba(var(--primary-neon-rgb), 0.8));
            animation: rotate-gradient 4s linear infinite;
        }

        .logo-icon-combo {
            width: 90%;
            height: 90%;
            background: var(--background);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4em;
            color: var(--primary-neon);
            position: relative;
        }

        .logo-icon-combo .fa-play {
            transform: translateX(4px);
        }

        .app-name {
            font-family: 'Roboto', sans-serif;
            font-size: 2.8em;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(45deg, var(--primary-neon), var(--primary-neon), var(--primary-neon));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 8px rgba(var(--primary-neon-rgb), 0.3);
        }

        #splash-screen .tagline {
            font-family: 'Roboto', sans-serif;
            font-size: 1.2em;
            font-style: italic;
            color: var(--text-secondary);
            margin-top: 5px;
            letter-spacing: 1px;
            padding: 0;
        }

        #splash-screen .tagline::after {
            content: '';
            display: block;
            width: 20px;
            height: 3px;
            background: var(--text-secondary);
            margin: 5px auto 0;
            border-radius: 3px;
        }

        .welcome-bottom {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 10px;
        }

        .get-started-btn {
            padding: 12px 35px;
            border: none;
            border-radius: 50px;
            background: var(--primary-neon);
            color: var(--background);
            font-family: 'Roboto', sans-serif;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(var(--primary-neon-rgb), 0.5);
        }

        #loading-container {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .loader {
            border: 4px solid rgba(var(--text-primary-rgb), 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary-neon);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .get-started-btn:hover {
            background: rgba(var(--primary-neon-rgb), 0.8);
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(var(--primary-neon-rgb), 0.7);
        }

        .creator-credit-new {
            font-family: 'Caveat', cursive;
            font-size: 1.1em;
            color: rgba(var(--text-secondary-rgb), 0.8);
            margin: 0;
        }

        #information-screen h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: var(--primary-neon);
            width: 100%;
            text-align: center;
        }

        #information-screen .profile-image-upload {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto 25px auto;
        }

        #information-screen #profile-image-preview {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-neon);
            background-color: var(--secondary-background);
        }

        #information-screen .profile-image-label {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--primary-neon);
            color: var(--background);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: 2px solid var(--background);
        }

        #information-screen #profile-image-input {
            display: none;
        }

        #information-screen .input-group {
            width: 100%;
            margin-bottom: 15px;
        }

        #information-screen label {
            display: block;
            margin-bottom: 5px;
            color: rgba(var(--text-primary-rgb), 0.8);
            font-size: 0.9em;
        }

        #information-screen input[type="text"],
        #information-screen input[type="tel"],
        #information-screen input[type="email"],
        #information-screen select {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background-color: rgba(var(--text-primary-rgb), 0.1);
            color: var(--text-primary);
            font-size: 1.1em;
            box-sizing: border-box;
        }

        #information-screen .custom-input {
            display: none;
            margin-top: 10px;
        }

        #information-screen .button-container {
            width: 100%;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #information-screen .continue-btn {
            background-color: var(--primary-neon);
            color: var(--background);
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
        }
        
        #long-video-load-more-btn {
            background-color: var(--primary-neon);
            color: var(--background);
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: auto;
            display: block;
            margin: 20px auto;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
        }
        
        #information-screen .continue-btn:disabled,
        #long-video-load-more-btn:disabled {
            background-color: var(--text-disabled);
            cursor: not-allowed;
        }

        #information-screen .logout-btn {
            background-color: var(--error-red);
            color: var(--text-primary);
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
        }

        #information-screen .logout-btn:hover {
            background-color: rgb(204, 0, 0);
        }

        #home-screen, #main-home-screen {
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #video-swiper {
            flex-grow: 1;
            width: 100%;
            height: 100%;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            -webkit-overflow-scrolling: touch;
        }

        .video-slide {
            width: 100%;
            height: 100%;
            scroll-snap-align: start;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--background);
        }

        .video-slide .player-container,
        .video-slide .html5-player {
            width: 100%;
            height: 100%;
            max-width: 420px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            object-fit: cover;
        }

        .video-slide iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-preloader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background);
            z-index: 2;
            display: flex;
            justify-content: center;
            align-items: center;
            background-size: cover;
            background-position: center;
        }

        .static-message {
            color: var(--text-secondary);
            font-size: 1.2em;
            text-align: center;
            padding: 20px;
            width: 100%;
        }

        .bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            height: 60px;
            background-color: rgba(var(--background-rgb), 0.7);
            backdrop-filter: blur(10px);
            position: absolute;
            bottom: 0;
            left: 0;
            z-index: 100;
            border-top: 1px solid rgba(var(--text-primary-rgb), 0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.7em;
            transition: color 0.3s ease;
            flex-grow: 1;
            height: 100%;
            padding-top: 5px;
        }

        .nav-item.active {
            color: transparent;
            background: linear-gradient(45deg, var(--primary-neon), var(--primary-neon));
            -webkit-background-clip: text;
            background-clip: text;
        }

        .nav-item.active i {
            color: transparent;
            background: linear-gradient(45deg, var(--primary-neon), var(--primary-neon));
            -webkit-background-clip: text;
            background-clip: text;
        }

        .nav-item i {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        #profile-screen {
            padding: 0;
            overflow-y: hidden;
            justify-content: flex-start;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #profile-header-new {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background-color: rgba(var(--secondary-background-rgb), 0.5);
            border-bottom: 1px solid rgba(var(--text-primary-rgb), 0.1);
            flex-shrink: 0;
        }

        #profile-header-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-neon);
        }

        #profile-your-zone-btn {
            flex-grow: 1;
            background-color: var(--primary-neon);
            color: var(--background);
            border: none;
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #profile-your-zone-btn:hover {
            opacity: 0.9;
        }

        #profile-video-toggle-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 15px 20px;
            border-bottom: 1px solid var(--text-secondary);
            flex-shrink: 0;
        }

        .profile-toggle-btn {
            padding: 8px 25px;
            border: 1px solid var(--text-secondary);
            background-color: transparent;
            color: var(--text-secondary);
            border-radius: 20px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .profile-toggle-btn.active {
            background-color: var(--primary-neon);
            color: var(--background);
            border-color: var(--primary-neon);
            font-weight: 700;
        }

        #profile-video-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            padding-bottom: 70px;
        }

        #user-short-video-grid,
        #user-long-video-grid {
            display: grid;
            gap: 5px;
            width: 100%;
        }

        #user-short-video-grid,
        #user-long-video-grid {
            grid-template-columns: 1fr;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        ::-webkit-scrollbar {
            width: 5px;
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: 5px;
        }

        .screen-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
            background-color: rgba(var(--background-rgb), 0.5);
            backdrop-filter: blur(5px);
            z-index: 50;
            border-bottom: 1px solid rgba(var(--text-primary-rgb), 0.1);
        }

        .screen-header.transparent {
            background-color: transparent;
            backdrop-filter: none;
            border-bottom: none;
        }

        .screen-header .header-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-icon-left,
        .header-icon-right {
            font-size: 1.6em;
            cursor: pointer;
            color: var(--text-primary);
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }

        .header-icon-left {
            left: 20px;
        }

        .header-icon-right {
            right: 20px;
        }

        .video-actions-overlay {
            position: absolute;
            bottom: 80px;
            right: 10px;
            z-index: 15;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            transition: bottom 0.4s ease;
        }

        .action-icon-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: var(--text-primary);
            text-align: center;
        }

        .action-icon-container .icon {
            font-size: 2.2em;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s ease, color 0.2s ease;
        }

        .action-icon-container[data-action="creator"] .icon {
            color: var(--text-primary);
        }

        .action-icon-container[data-action="creator"] .count {
            font-size: 0.8em;
        }

        .action-icon-container[data-action="comment"] .icon {
            color: var(--primary-neon);
        }

        .action-icon-container:hover .icon {
            transform: scale(1.1);
        }

        .action-icon-container .count {
            font-size: 0.9em;
            font-weight: 700;
            margin-top: 4px;
        }

        .home-top-bar {
            width: 100%;
            height: 50px;
            background-color: var(--background);
            display: flex;
            align-items: center;
            padding: 0 10px;
            z-index: 50;
            flex-shrink: 0;
            border-bottom: 1px solid var(--secondary-background);
        }

        .home-menu-icon {
            font-size: 1.6em;
            padding: 0 10px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .category-scroller {
            flex-grow: 1;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .category-scroller::-webkit-scrollbar {
            display: none;
        }

        .category-chip {
            padding: 6px 15px;
            background-color: var(--secondary-background);
            border: 1px solid var(--text-secondary);
            color: var(--text-primary);
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .category-chip.active {
            background-color: var(--primary-neon);
            color: var(--background);
            border-color: var(--primary-neon);
            font-weight: 700;
        }

        .video-meta-overlay {
            position: absolute;
            bottom: 65px;
            left: 0;
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            background: linear-gradient(to top, rgba(var(--background-rgb), 0.5), transparent);
            z-index: 10;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-start;
            transition: bottom 0.4s ease;
        }

        .video-meta-overlay .uploader-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .video-meta-overlay .uploader-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--text-primary);
        }

        .video-meta-overlay .uploader-name {
            font-weight: 500;
            font-size: 1em;
        }

        .video-meta-overlay .video-title {
            font-weight: 400;
            font-size: 0.9em;
            margin: 0;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }

        .add-channel-btn {
            pointer-events: auto;
            background-color: rgba(var(--secondary-background-rgb), 0.7);
            color: var(--primary-neon);
            border: 1px solid var(--primary-neon);
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .add-channel-btn:hover {
            background-color: var(--primary-neon);
            color: var(--background);
        }

        .add-channel-btn i {
            font-size: 0.9em;
        }

        .add-channel-btn-long-grid {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            color: var(--primary-neon);
            border: 1px solid var(--primary-neon);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 5;
            opacity: 0;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .long-video-card:hover .add-channel-btn-long-grid {
            opacity: 1;
        }

        .add-channel-btn-long-grid:hover {
            background-color: var(--primary-neon);
            color: var(--background);
        }

        .comments-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .comments-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .comments-modal-content {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60%;
            max-height: 70vh;
            background-color: var(--secondary-background);
            border-radius: 15px 15px 0 0;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .comments-modal-overlay.active .comments-modal-content {
            transform: translateY(0);
        }

        .comments-header {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid var(--text-secondary);
            position: relative;
        }

        .comments-header h4 {
            margin: 0;
            font-size: 1.1em;
            color: var(--text-primary);
        }

        .comments-header .close-comments-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-primary);
        }

        #comments-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            list-style: none;
            margin: 0;
            color: var(--text-primary);
        }

        .comment-input-container {
            display: flex;
            padding: 10px 15px;
            border-top: 1px solid var(--text-secondary);
            gap: 10px;
        }

        #comment-input {
            flex-grow: 1;
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--text-secondary);
            border-radius: 20px;
            padding: 10px 15px;
            color: var(--text-primary);
            font-size: 1em;
        }

        #send-comment-btn {
            background: none;
            border: none;
            color: var(--primary-neon);
            font-size: 1.8em;
            cursor: pointer;
        }

        .main-sidebar {
            position: absolute;
            top: 0;
            left: 0;
            width: 280px;
            height: 100%;
            background-color: var(--secondary-background);
            z-index: 1001;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.5);
            color: var(--text-primary);
        }

        .main-sidebar.open {
            transform: translateX(0);
        }

        .sidebar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
        }

        .sidebar-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--text-secondary);
        }

        .sidebar-header h3 {
            margin: 0;
            color: var(--primary-neon);
        }

        .close-sidebar-btn {
            font-size: 2em;
            cursor: pointer;
            line-height: 1;
            color: var(--text-primary);
        }

        .sidebar-option {
            background: var(--secondary-background);
            border: 1px solid var(--text-secondary);
            color: var(--text-primary);
            padding: 15px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            border-radius: 8px;
            font-size: 1.1em;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .sidebar-option:hover {
            background-color: rgba(var(--text-primary-rgb), 0.1);
            border-color: var(--primary-neon);
        }

        .premium-features-card {
            display: block;
            margin-top: 10px;
            width: 100%;
            text-decoration: none;
            color: var(--text-primary);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 12px;
        }

        .premium-features-card:hover {
            transform: scale(1.03);
            box-shadow: 0 0 20px rgba(var(--primary-neon-rgb), 0.7);
        }

        .premium-features-card .premium-image-wrapper {
            aspect-ratio: 1 / 1;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 2px solid var(--primary-neon);
            background-color: var(--secondary-background);
        }

        .premium-features-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .premium-features-card span {
            font-size: 1.1em;
            font-weight: 600;
            display: block;
        }

        #long-video-screen,
        #history-screen {
            padding: 0;
            overflow-y: hidden;
            height: 100%;
        }

        .long-video-screen-content,
        .history-content {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            padding-bottom: 60px;
        }

        #long-video-top-bar,
        #history-top-bar {
            width: 100%;
            height: 50px;
            background-color: var(--background);
            display: flex;
            align-items: center;
            padding: 0 10px;
            flex-shrink: 0;
            border-bottom: 1px solid var(--secondary-background);
        }

        #long-video-menu-icon,
        #history-menu-icon {
            font-size: 1.6em;
            padding: 0 10px;
            cursor: pointer;
            color: var(--text-primary);
        }

        #long-video-category-scroller {
            flex-grow: 1;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            padding: 0 5px;
        }

        #long-video-category-scroller::-webkit-scrollbar,
        #history-shorts-scroller::-webkit-scrollbar {
            display: none;
        }

        #long-video-carousel-container {
            width: 100%;
            overflow-x: auto;
            padding: 15px 0;
            position: relative;
            flex-shrink: 0;
            -ms-overflow-style: none;
            scrollbar-width: none;
            background-color: var(--secondary-background);
        }

        #long-video-carousel-container::-webkit-scrollbar {
            display: none;
        }

        #long-video-carousel-wrapper {
            display: flex;
            width: fit-content;
        }

        .carousel-card {
            flex-shrink: 0;
            width: 284px;
            height: 160px;
            margin: 0 8px;
            border-radius: 12px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--text-secondary);
            color: var(--text-primary);
        }

        .carousel-card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--primary-neon);
        }

        .long-video-search-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            border-bottom: 1px solid var(--secondary-background);
            flex-shrink: 0;
        }

        #long-video-search-input {
            flex-grow: 1;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--text-secondary);
            background-color: var(--secondary-background);
            color: var(--text-primary);
            font-size: 1em;
        }

        #long-video-search-btn,
        #long-video-history-btn {
            background-color: var(--secondary-background);
            border: none;
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }

        #long-video-search-btn:hover,
        #long-video-history-btn:hover {
            background-color: var(--primary-neon);
        }

        #long-video-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            padding: 20px;
            width: 100%;
        }

        .long-video-card {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background-color: var(--secondary-background);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
        }

        /* ★★★ FIX: वीडियो कार्ड को 16:9 का अनुपात दिया गया ★★★ */
        .long-video-thumbnail {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        .long-video-card:hover .long-video-thumbnail {
            transform: scale(1.05);
        }

        .play-icon-overlay {
            font-size: 3em;
            color: rgba(var(--text-primary-rgb), 0.8);
            background-color: rgba(0, 0, 0, 0.4);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s ease;
        }

        .long-video-card:hover .play-icon-overlay {
            opacity: 1;
            transform: scale(1);
        }

        .long-video-info-container {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .long-video-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 3px;
            overflow: hidden;
        }

        .long-video-name {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .long-video-uploader {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        #history-top-bar {
            justify-content: space-between;
        }

        #history-date-button {
            background: none;
            border: 1px solid var(--text-secondary);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        #history-date-button:hover {
            background-color: var(--secondary-background);
        }

        .history-section-title {
            padding: 15px 20px 5px 20px;
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
        }

        #history-shorts-scroller {
            display: flex;
            overflow-x: auto;
            padding: 10px 20px;
            gap: 10px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .history-short-card {
            width: 100px;
            aspect-ratio: 9 / 16;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .history-short-card:hover {
            transform: scale(1.05);
        }

        .history-short-card .history-item-menu {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .history-short-card:hover .history-item-menu {
            opacity: 1;
        }

        .history-short-card .history-item-menu:hover {
            background-color: var(--error-red);
        }

        #history-long-video-list {
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-list-item {
            display: flex;
            align-items: center;
            background-color: var(--secondary-background);
            border-radius: 8px;
            padding: 8px;
            gap: 12px;
            cursor: pointer;
        }

        .history-item-thumbnail {
            width: 120px;
            height: 67.5px;
            border-radius: 6px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .history-item-info {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .history-item-title {
            font-weight: 500;
            font-size: 0.95em;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            color: var(--text-primary);
        }

        .history-item-uploader {
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .history-item-menu {
            padding: 10px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1.1em;
            align-self: center;
            transition: color 0.2s ease;
        }

        .history-item-menu:hover {
            color: var(--error-red);
        }

        #friends-screen {
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
            background-color: var(--background);
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif;
        }

        .friends-top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 999;
            padding: 10px 15px;
            background-color: rgba(var(--background-rgb), 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(var(--primary-neon-rgb), 0.1);
        }

        .friends-top-bar .tab-bar {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }

        .friends-top-bar .tab-button {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid rgba(var(--primary-neon-rgb), 0.2);
            background-color: transparent;
            border-radius: 12px;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .friends-top-bar .tab-button.active {
            background-color: var(--primary-neon);
            color: var(--background);
            border-color: var(--primary-neon);
            box-shadow: 0 0 5px var(--primary-neon);
        }

        #friends-screen .content-area {
            flex-grow: 1;
            padding: 80px 15px 80px 15px;
            overflow-y: auto;
            height: 100%;
        }

        #friends-screen .content-area::-webkit-scrollbar,
        #friends-screen .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        #friends-screen .content-area::-webkit-scrollbar-track,
        #friends-screen .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        #friends-screen .content-area::-webkit-scrollbar-thumb,
        #friends-screen .chat-messages::-webkit-scrollbar-thumb {
            background-color: var(--primary-neon);
            border-radius: 4px;
        }

        .add-friend-search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        #add-friend-search-input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid var(--text-secondary);
            border-radius: 8px;
            background-color: var(--secondary-background);
            color: var(--text-primary);
            font-size: 1em;
        }

        #add-friend-search-btn {
            padding: 0 20px;
            border: none;
            background-color: var(--primary-neon);
            color: var(--background);
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        #add-friend-search-btn:hover {
            opacity: 0.9;
        }

        .holographic-card {
            display: flex;
            align-items: center;
            background-color: rgba(var(--secondary-background-rgb), 0.5);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(var(--primary-neon-rgb), 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            cursor: default;
            position: relative;
            width: 100%;
        }

        .holographic-card[onclick] {
            cursor: pointer;
        }

        .holographic-card:hover {
            border-color: rgba(var(--primary-neon-rgb), 0.5);
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .holographic-card .profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            background-color: var(--background);
            overflow: hidden;
            border: 2px solid rgba(var(--primary-neon-rgb), 0.2);
            flex-shrink: 0;
            cursor: pointer;
        }

        .holographic-card .profile-pic img,
        .chat-app-bar .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .holographic-card .info {
            flex-grow: 1;
            min-width: 0;
        }

        .holographic-card .info .name {
            font-weight: 700;
            font-size: 16px;
            color: var(--text-primary);
        }

        .holographic-card .info .subtext {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .add-button {
            background: var(--primary-neon);
            color: var(--background);
            border: none;
            border-radius: 20px;
            padding: 8px 18px;
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-button:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        .add-button.requested {
            background: var(--secondary-background);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .request-actions,
        .channel-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .request-actions button,
        .channel-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .request-actions .accept-button,
        .channel-actions .open-button {
            background-color: var(--success-green);
            color: var(--background);
        }

        .request-actions .reject-button,
        .channel-actions .reject-button {
            background-color: var(--error-red);
            color: var(--text-primary);
        }

        .channel-actions .reject-button {
            padding: 8px;
            width: 35px;
            height: 35px;
        }

        .channel-actions .reject-button i {
            font-size: 1em;
        }

        #friends-screen .hidden {
            display: none !important;
        }

        #chat-screen-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--background);
            display: flex;
            flex-direction: column;
            z-index: 2000;
            opacity: 0;
            transform: translateX(100%);
            transition: transform 0.4s ease-in-out;
            pointer-events: none;
        }

        #chat-screen-overlay.active {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        .chat-app-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            padding: 10px 15px;
            height: 60px;
            background-color: rgba(var(--secondary-background-rgb), 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(var(--primary-neon-rgb), 0.2);
        }

        .chat-app-bar .back-arrow {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            margin-right: 10px;
        }

        .chat-app-bar .profile-pic {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 15px;
        }

        .chat-app-bar .username {
            font-weight: 700;
            font-size: 18px;
            color: var(--text-primary);
        }

        .chat-messages {
            flex-grow: 1;
            padding: 70px 15px 90px 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            word-wrap: break-word;
            font-size: 16px;
        }

        .message-bubble.sender {
            align-self: flex-end;
            background: var(--primary-neon);
            color: var(--background);
            border-radius: 12px 12px 0 12px;
        }

        .message-bubble.receiver {
            align-self: flex-start;
            background-color: var(--secondary-background);
            color: var(--text-primary);
            border-radius: 12px 12px 12px 0;
        }

        .chat-input-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: rgba(var(--secondary-background-rgb), 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(var(--primary-neon-rgb), 0.2);
        }

        .chat-input-bar .input-field {
            flex-grow: 1;
            background: none;
            border: none;
            outline: none;
            padding: 12px 15px;
            border-radius: 20px;
            background-color: rgba(0, 0, 0, 0.2);
            margin: 0 10px;
            font-size: 16px;
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .chat-input-bar .input-field:focus {
            border-color: var(--primary-neon);
            box-shadow: 0 0 10px rgba(var(--primary-neon-rgb), 0.3);
        }

        .chat-input-bar .send-button {
            background: var(--primary-neon);
            color: var(--background);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.5;
            transform: scale(0.8);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .chat-input-bar .send-button.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
            box-shadow: 0 0 5px var(--primary-neon);
        }

        .loader-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 0;
        }

        #creator-page-screen .content-area {
            overflow: hidden;
            height: calc(100% - 60px);
            padding: 60px 0 0 0;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        #creator-page-screen .content-area.player-active {
            height: 100%;
            padding-top: 0;
        }

        #creator-page-screen .screen-header {
            justify-content: center;
            position: relative;
            background-color: rgba(var(--background-rgb), 0.7);
            backdrop-filter: blur(10px);
        }

        #creator-page-tabs {
            display: flex;
            justify-content: center;
            gap: 5px;
            background-color: rgba(var(--secondary-background-rgb), 0.5);
            padding: 5px;
            border-radius: 20px;
            border: 1px solid var(--text-secondary);
            margin: 0 auto;
        }

        .creator-page-tab-btn {
            padding: 6px 15px;
            border: none;
            background-color: transparent;
            color: var(--text-secondary);
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .creator-page-tab-btn.active {
            background-color: var(--primary-neon);
            color: var(--background);
            font-weight: 700;
        }

        .creator-video-grid,
        .creator-playlist-list {
            height: 100%;
            overflow-y: auto;
            padding: 15px;
            box-sizing: border-box;
        }

        .creator-video-grid {
            display: grid;
            gap: 15px;
        }

        .creator-video-grid.long-video-list {
            grid-template-columns: 1fr;
        }

        .creator-video-grid.long-video-list .long-video-card {
            margin-bottom: 0;
        }

        .creator-video-grid.short-video-list {
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .creator-video-grid.short-video-list .history-short-card {
            width: 100%;
        }

        /* ★★★ NEW & MODIFIED: नए वीडियो प्लेयर पेज के लिए स्टाइल ★★★ */
        #creator-page-player-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #000;
            position: relative;
            flex-grow: 1;
        }

        .player-controls-header {
            position: absolute;
            top: 15px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            z-index: 30;
            pointer-events: none;
            /* ताकि बटन के अलावा कहीं और क्लिक करने पर वीडियो पर क्लिक हो */
        }

        .player-controls-header>* {
            pointer-events: auto;
            /* बटनों को क्लिक करने योग्य बनाएं */
        }

        /* MODIFIED: पुरानी स्टाइल हटाई गई, क्योंकि अब यह फ्लेक्स आइटम है */
        .player-back-button {
            color: var(--text-primary);
            background-color: rgba(0, 0, 0, 0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            cursor: pointer;
        }

        /* NEW: ज़ूम कंट्रोल कंटेनर के लिए स्टाइल */
        .player-zoom-controls {
            display: flex;
            gap: 10px;
        }

        /* NEW: प्लेयर हेडर में सभी बटनों के लिए सामान्य स्टाइल */
        .player-controls-header button {
            color: var(--text-primary);
            background-color: rgba(0, 0, 0, 0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .player-controls-header button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* MODIFIED: पुरानी स्टाइल हटाई गई */
        #player-rotate-btn {
            /* अब सामान्य बटन स्टाइल का उपयोग करेगा */
        }

        #player-rotate-btn i {
            transition: transform 0.3s ease;
        }

        .fullscreen-active #player-rotate-btn i {
            transform: rotate(90deg);
        }

        /* MODIFIED: ज़ूम इफ़ेक्ट के लिए ट्रांजीशन जोड़ा गया */
        .player-wrapper {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #000;
            transition: transform 0.3s ease;
            /* स्मूथ ज़ूम के लिए */
        }

        #creator-page-player-long {
            width: 100%;
            height: 100%;
        }

        .fullscreen-active #creator-page-player-container .player-wrapper {
            width: 100%;
            height: 100%;
            aspect-ratio: auto;
        }
       
        .continue-btn,
        .logout-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .continue-btn {
            background-color: var(--primary-neon);
            color: var(--background);
        }

        .continue-btn:disabled {
            background-color: var(--text-disabled);
            cursor: not-allowed;
        }

        #image-enlarge-modal .enlarged-image-content {
            background-color: transparent;
            padding: 0;
            width: 90vw;
            height: 80vh;
            max-width: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: none;
        }

        #image-enlarge-modal img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(var(--primary-neon-rgb), 0.5);
        }

        @media (min-width: 768px) {
            body {
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                /* ★ बदलाव: बैकग्राउंड पैटर्न को हटा दिया गया है */
                background-color: var(--background);
            }

            .app-container {
                height: min(var(--app-height, 90vh), 850px);
                border-radius: 24px;
                border: 8px solid #000;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                margin: auto;
            }

            .app-container.fullscreen-active {
                height: 100vh;
            }
        }
    </style>
</head>

<body>

    <!-- === SIDEBAR START === -->
    <div id="main-sidebar" class="main-sidebar">
        <div class="sidebar-header">
            <h3>Menu</h3>
            <span id="close-sidebar-btn" class="close-sidebar-btn haptic-trigger">×</span>
        </div>

        <div id="sidebar-profile-btn" class="sidebar-option haptic-trigger">
            <i class="fas fa-user" style="margin-right: 15px;"></i>
            <span>Profile</span>
        </div>

        <a href="https://shubhzone.onrender.com" target="_blank" rel="noopener noreferrer"
            class="premium-features-card haptic-trigger">
            <div class="premium-image-wrapper">
                <img src="https://i.ibb.co/0RF4GmTZ/Flux-Dev-A-futuristic-social-media-interface-named-Shubhzone-g-1.jpg"
                    alt="Premium Features Image">
            </div>
            <span>Premium Features</span>
        </a>

    </div>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
    <!-- === SIDEBAR END === -->

    <!-- === ALL MODALS START === -->
    <div id="comments-modal" class="comments-modal-overlay">
        <div class="comments-modal-content">
            <div class="comments-header">
                <h4>Comments</h4>
                <span class="close-comments-btn haptic-trigger" onclick="closeCommentsModal()">×</span>
            </div>
            <ul id="comments-list"></ul>
            <div class="comment-input-container">
                <input type="text" id="comment-input" placeholder="Commenting is disabled." disabled>
                <button id="send-comment-btn" class="haptic-trigger" disabled><i
                        class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="image-enlarge-modal" class="modal-overlay">
        <div class="enlarged-image-content">
            <img id="enlarged-image-src" src="" alt="Enlarged View">
        </div>
    </div>
    <!-- === ALL MODALS END === -->

    <div class="app-container" id="app-container">

        <!-- === SPLASH SCREEN === -->
        <div id="splash-screen" class="screen active">
            <div class="welcome-top">
                <h1 class="welcome-text">Welcome ☁️</h1>
            </div>
            <div class="welcome-center">
                <div class="logo-container">
                    <div class="logo-ring"></div>
                    <div class="logo-icon-combo">
                        <i class="fas fa-play"></i>
                    </div>
                </div>
                <h2 class="app-name">Shubhzone</h2>
                <p class="tagline">Har Hunar ka Ghar</p>
            </div>
            <div class="welcome-bottom">
                <button id="get-started-btn" class="get-started-btn haptic-trigger">Get Started</button>
                <div id="loading-container" style="display: none;">
                    <div class="loader"></div>
                    <p style="margin-top: 10px;">Loading Videos, Please Wait...</p>
                </div>
                <p class="creator-credit-new">Made with ❤️ by Udbhav</p>
            </div>
        </div>

        <!-- === INFORMATION SCREEN === -->
        <div id="information-screen" class="screen">
            <div class="screen-header">
                <span class="header-title">Mera Shubhzone</span>
            </div>
            <div style="margin-top: 60px; width: 100%; overflow-y: auto; padding: 20px;">
                <div class="profile-image-upload">
                    <img id="profile-image-preview" src="https://via.placeholder.com/120/222/FFFFFF?text=+"
                        alt="Profile Preview">
                    <label for="profile-image-input" class="profile-image-label haptic-trigger">
                        <i class="fas fa-camera"></i>
                    </label>
                    <input type="file" id="profile-image-input" accept="image/*">
                </div>
                <div class="input-group">
                    <label for="info-name">Name</label>
                    <input type="text" id="info-name" placeholder="Enter your name">
                </div>
                <div class="input-group">
                    <label for="info-referral">Referral ID (Optional)</label>
                    <input type="text" id="info-referral" placeholder="Enter referral ID if you have one">
                </div>
                <div class="input-group">
                    <label for="info-mobile">Mobile No.</label>
                    <input type="tel" id="info-mobile" placeholder="Enter your mobile number">
                </div>
                <div class="input-group">
                    <label for="info-email">Email ID</label>
                    <input type="email" id="info-email" placeholder="Enter your email">
                </div>
                <div class="input-group">
                    <label for="info-address">Address</label>
                    <input type="text" id="info-address" placeholder="Enter your address">
                </div>
                <div class="input-group">
                    <label for="info-hobby">Hobby</label>
                    <input type="text" id="info-hobby" placeholder="e.g., Reading, Gaming, Coding">
                </div>
                <div class="input-group">
                    <label for="info-state">State</label>
                    <select id="info-state" onchange="checkCustom(this, 'custom-state-input')">
                        <option value="">Select State</option>
                        <option value="Andhra Pradesh">Andhra Pradesh</option>
                        <option value="Delhi">Delhi</option>
                        <option value="Gujarat">Gujarat</option>
                        <option value="Karnataka">Karnataka</option>
                        <option value="Maharashtra">Maharashtra</option>
                        <option value="Rajasthan">Rajasthan</option>
                        <option value="Tamil Nadu">Tamil Nadu</option>
                        <option value="Uttar Pradesh">Uttar Pradesh</option>
                        <option value="West Bengal">West Bengal</option>
                        <option value="custom">Other</option>
                    </select>
                    <input type="text" id="custom-state-input" class="custom-input"
                        placeholder="Please specify your state">
                </div>
                <div class="input-group">
                    <label for="info-country">Country</label>
                    <select id="info-country" onchange="checkCustom(this, 'custom-country-input')">
                        <option value="India">India</option>
                        <option value="custom">Custom</option>
                    </select>
                    <input type="text" id="custom-country-input" class="custom-input"
                        placeholder="Please specify your country">
                </div>
                <div class="button-container">
                    <button id="save-continue-btn" class="continue-btn haptic-trigger"
                        onclick="saveAndContinue()">Continue</button>
                    <button class="logout-btn haptic-trigger" onclick="logoutUser()">Logout</button>
                </div>
            </div>
        </div>

        <!-- ★★★ नया बदलाव: नया खाली होम स्क्रीन ★★★ -->
        <div id="main-home-screen" class="screen">
            <div style="flex-grow: 1; display: flex; justify-content: center; align-items: center; padding: 20px;">
                 <h2 style="color: var(--text-secondary); font-weight: 500; text-align: center;">Welcome to Shubhzone</h2>
            </div>
            <div class="bottom-nav">
                <div class="nav-item active" data-nav="home"><i class="fas fa-home"></i>Home</div>
                <div class="nav-item" data-nav="long-video"><i class="fas fa-video"></i>Long Video</div>
                <div class="nav-item" data-nav="shorts"><i class="fas fa-compact-disc"></i>Shorts</div>
                <div class="nav-item" data-nav="friends"><i class="fas fa-user-friends"></i>Friends</div>
                <div class="nav-item" data-nav="profile" style="display: none;"><i class="fas fa-user"></i>Profile</div>
            </div>
        </div>

        <!-- === SHORTS SCREEN (ID 'home-screen' ही है) === -->
        <div id="home-screen" class="screen">
            <div class="home-top-bar">
                <div id="shorts-menu-icon" class="home-menu-icon haptic-trigger">
                    <i class="fas fa-bars"></i>
                </div>
                <div id="category-scroller" class="category-scroller"></div>
            </div>
            <div id="video-swiper">
                <div id="home-static-message-container" style="display: flex;">
                    <p class="static-message">Loading shorts...</p>
                </div>
            </div>
            <div class="bottom-nav">
                <div class="nav-item" data-nav="home"><i class="fas fa-home"></i>Home</div>
                <div class="nav-item" data-nav="long-video"><i class="fas fa-video"></i>Long Video</div>
                <div class="nav-item active" data-nav="shorts"><i class="fas fa-compact-disc"></i>Shorts</div>
                <div class="nav-item" data-nav="friends"><i class="fas fa-user-friends"></i>Friends</div>
                <div class="nav-item" data-nav="profile" style="display: none;"><i class="fas fa-user"></i>Profile</div>
            </div>
        </div>

        <!-- === LONG VIDEO SCREEN === -->
        <div id="long-video-screen" class="screen">
            <div class="long-video-screen-content">
                <div id="long-video-top-bar">
                    <div id="long-video-menu-icon" class="home-menu-icon haptic-trigger">
                        <i class="fas fa-bars"></i>
                    </div>
                    <div id="long-video-category-scroller" class="category-scroller"></div>
                </div>
                <div id="long-video-carousel-container">
                    <div id="long-video-carousel-wrapper"></div>
                </div>
                <div class="long-video-search-container">
                    <input type="text" id="long-video-search-input" placeholder="Search or paste YouTube link...">
                    <button id="long-video-search-btn" class="haptic-trigger"><i class="fas fa-search"></i></button>
                    <button id="long-video-history-btn" class="haptic-trigger"><i class="fas fa-history"></i></button>
                </div>
                <div id="long-video-grid"></div>
                <!-- "Load More" button is dynamically added here by script.js -->
            </div>
            <div class="bottom-nav">
                <div class="nav-item" data-nav="home"><i class="fas fa-home"></i>Home</div>
                <div class="nav-item active" data-nav="long-video"><i class="fas fa-video"></i>Long Video</div>
                <div class="nav-item" data-nav="shorts"><i class="fas fa-compact-disc"></i>Shorts</div>
                <div class="nav-item" data-nav="friends"><i class="fas fa-user-friends"></i>Friends</div>
                <div class="nav-item" data-nav="profile" style="display: none;"><i class="fas fa-user"></i>Profile</div>
            </div>
        </div>

        <!-- === HISTORY SCREEN === -->
        <div id="history-screen" class="screen">
            <div class="history-content">
                <div id="history-top-bar">
                    <div id="back-from-history-btn" class="home-menu-icon haptic-trigger">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <span class="header-title">Watch History</span>
                    <button id="history-date-button" class="haptic-trigger">Clear All</button>
                </div>
                <div class="history-section-title">Recently Watched Shorts</div>
                <div id="history-shorts-scroller"></div>
                <div class="history-section-title">Watched Videos</div>
                <div id="history-long-video-list"></div>
            </div>
            <div class="bottom-nav">
                <div class="nav-item" data-nav="home"><i class="fas fa-home"></i>Home</div>
                <div class="nav-item" data-nav="long-video"><i class="fas fa-video"></i>Long Video</div>
                <div class="nav-item" data-nav="shorts"><i class="fas fa-compact-disc"></i>Shorts</div>
                <div class="nav-item" data-nav="friends"><i class="fas fa-user-friends"></i>Friends</div>
                <div class="nav-item" data-nav="profile" style="display: none;"><i class="fas fa-user"></i>Profile</div>
            </div>
        </div>

        <!-- === FRIENDS SCREEN === -->
        <div id="friends-screen" class="screen">
            <div class="friends-top-bar">
                <div class="tab-bar">
                    <button class="tab-button active" data-tab="add">Add Friends</button>
                    <button class="tab-button" data-tab="requests">Requests</button>
                    <button class="tab-button" data-tab="members">Members</button>
                </div>
            </div>

            <main class="content-area">
                <div class="tab-content" id="add-content">
                    <div class="add-friend-search-container">
                        <input type="text" id="add-friend-search-input" placeholder="Search by Name or @ID">
                        <button id="add-friend-search-btn" class="haptic-trigger">Search</button>
                    </div>
                    <div id="add-friend-user-list"></div>
                </div>
                <div class="tab-content hidden" id="requests-content"></div>
                <div class="tab-content hidden" id="members-content"></div>
            </main>

            <div class="chat-screen" id="chat-screen-overlay">
                <header class="chat-app-bar">
                    <button class="icon-button back-arrow haptic-trigger"><i class="fas fa-arrow-left"></i></button>
                    <div class="profile-pic"><img src="" alt="Chat User Avatar" id="chat-user-profile-pic"></div>
                    <div class="username" id="chat-username"></div>
                </header>
                <div class="chat-messages" id="chat-messages"></div>
                <div class="chat-input-bar">
                    <input type="text" class="input-field" placeholder="Message...">
                    <button class="send-button haptic-trigger" id="send-button"><i
                            class="fas fa-paper-plane"></i></button>
                </div>
            </div>

            <div class="bottom-nav">
                <div class="nav-item" data-nav="home"><i class="fas fa-home"></i>Home</div>
                <div class="nav-item" data-nav="long-video"><i class="fas fa-video"></i>Long Video</div>
                <div class="nav-item" data-nav="shorts"><i class="fas fa-compact-disc"></i>Shorts</div>
                <div class="nav-item active" data-nav="friends"><i class="fas fa-user-friends"></i>Friends</div>
                <div class="nav-item" data-nav="profile" style="display: none;"><i class="fas fa-user"></i>Profile</div>
            </div>
        </div>

        <!-- === PROFILE SCREEN (Accessed via Sidebar) === -->
        <div id="profile-screen" class="screen">
            <div id="profile-header-new">
                <img id="profile-header-avatar" src="https://via.placeholder.com/50/222/FFFFFF?text=+" alt="Avatar">
                <button id="profile-your-zone-btn" class="haptic-trigger">Edit Profile</button>
            </div>
            <div id="profile-video-toggle-buttons">
                <button id="profile-show-shorts-btn" class="profile-toggle-btn active haptic-trigger">Short
                    Video</button>
                <button id="profile-show-longs-btn" class="profile-toggle-btn haptic-trigger">Long Video</button>
            </div>
            <div id="profile-video-content">
                <div id="user-short-video-grid"></div>
                <div id="user-long-video-grid" style="display: none;"></div>
            </div>
            <!-- No nav bar here as it's a deep-link screen -->
        </div>

        <!-- === CREATOR PAGE SCREEN === -->
        <div id="creator-page-screen" class="screen">
            <div class="screen-header">
                <div class="header-icon-left haptic-trigger" onclick="navigateBack()"><i
                        class="fas fa-arrow-left"></i></div>
                <div id="creator-page-tabs"></div>
            </div>
            <div id="creator-page-content" class="content-area">
                <!-- Content injected by JS -->
            </div>
        </div>

    </div> <!-- End of .app-container -->

    <!-- === SCRIPTS (MUST BE AT THE END) === -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // Firebase कॉन्फ़िगरेशन
        const firebaseConfig = {
            apiKey: "AIzaSyDuvWTMJL5edNG6cheez5pmwI2KlLCwtjw",
            authDomain: "shubhzone-4a6b0.firebaseapp.com",
            databaseURL: "https://shubhzone-4a6b0-default-rtdb.firebaseio.com",
            projectId: "shubhzone-4a6b0",
            storageBucket: "shubhzone-4a6b0.appspot.com",
            messagingSenderId: "439309269785",
            appId: "1:439309269785:web:08a1256812648daafea388",
            measurementId: "G-5S0VFF21SB"
        };

        // Firebase को केवल एक बार शुरू करें
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Firebase सेवाओं को इनिशियलाइज़ करें
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const analytics = firebase.analytics();

        // =================================================
        // ★★★ Helper Functions - START ★★★
        // =================================================

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function copyToClipboard(text, event) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    const copyBtn = event.target.closest('button');
                    if (copyBtn) {
                        const originalContent = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalContent;
                        }, 2000);
                    }
                }).catch(err => {
                    console.error('Failed to copy text with modern method: ', err);
                    fallbackCopyToClipboard(text, event);
                });
            } else {
                fallbackCopyToClipboard(text, event);
            }
        }

        function fallbackCopyToClipboard(text, event) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = 0;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                const copyBtn = event.target.closest('button');
                if (copyBtn) {
                    const originalContent = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    setTimeout(() => {
                        copyBtn.innerHTML = originalContent;
                    }, 2000);
                }
            } catch (err) {
                console.error('Fallback copy to clipboard failed', err);
                alert('Failed to copy text.');
            }
            document.body.removeChild(textArea);
        }

        async function generateAndSaveReferralCode(uid, name) {
            const safeName = (name || 'user').replace(/[^a-zA-Z]/g, '').toLowerCase().substring(0, 2);
            const randomPart = Math.random().toString().substring(2, 5);
            let referralCode = `@${safeName}${randomPart}`;

            while (referralCode.length < 6) {
                referralCode += Math.floor(Math.random() * 10);
            }

            try {
                await db.collection('users').doc(uid).update({
                    referralCode: referralCode
                });
                console.log(`Generated Referral Code: ${referralCode}`);
                return referralCode;
            } catch (error) {
                console.error("Error saving referral code:", error);
                return "COULD_NOT_GENERATE";
            }
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return 0;
            if (num >= 10000000) return (num / 10000000).toFixed(1).replace(/\.0$/, '') + 'Cr';
            if (num >= 100000) return (num / 100000).toFixed(1).replace(/\.0$/, '') + 'L';
            if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
            return num;
        }

        function extractYouTubeId(url) {
            if (!url) return null;
            if (/^[a-zA-Z0-9_-]{11}$/.test(url)) {
                return url;
            }
            const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        // =================================================
        // ★★★ Helper Functions - END ★★★
        // =================================================

        let appState = {
            currentUser: {
                uid: null,
                username: "new_user",
                avatar: "https://via.placeholder.com/120/222/FFFFFF?text=+",
                email: "",
                name: "",
                mobile: "",
                address: "",
                hobby: "",
                state: "",
                country: "",
                referralCode: null,
                likedVideos: [],
                friends: [],
                addedChannels: [],
            },
            currentScreen: 'splash-screen',
            navigationStack: ['splash-screen'],
            currentScreenPayload: null,
            viewingHistory: [],
            youtubeNextPageTokens: {
                long: null,
                shorts: null,
                search: null,
                trending: null,
                channelVideos: null,
                channelShorts: null,
                channelPlaylists: null,
            },
            longVideoSearchContext: {
                type: 'query',
                value: null
            },
            uploadDetails: {
                category: null,
                audience: 'all',
                lengthType: 'short'
            },
            activeComments: {
                videoId: null,
                videoOwnerUid: null,
                channelId: null
            },
            activeChat: {
                chatId: null,
                friendId: null,
                friendName: null,
                friendAvatar: null
            },
            creatorPagePlayers: {
                short: null,
                long: null
            },
            creatorPage: {
                currentLongVideo: {
                    id: null,
                    uploaderUid: null,
                    channelId: null
                },
                channelCache: new Map(),
                currentView: 'channel',
                currentChannelId: null,
            },
            specialVideoPlayer: null,
        };


        let isYouTubeApiReady = false;
        let players = {};
        let videoObserver;
        let activePlayerId = null;
        let userHasInteracted = false;
        let hasShownAudioPopup = false;
        let hapticFeedbackEnabled = true;
        let youtubePlayerQueue = [];

        // =============================================================================
        // ★★★ YOUTUBE API INTEGRATION (REFACTORED & WITH FIREBASE CACHING) - START ★★★
        // =============================================================================

        let currentVideoCache = new Map();
        
        async function fetchFromYouTubeAPI(type, params) {
            
            // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
            // ★★★ FINAL FIX: सर्वर का URL ठीक किया गया ★★★
            // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
            // यह सर्वर को हमेशा उसी डोमेन पर कॉल करेगा जिस पर ऐप चल रहा है।
            // let url = `https://youtube-7lwy.onrender.com/api/youtube?type=${type}`; // <-- यह गलत था
            let url = `/api/youtube?type=${type}`; // <-- यह सही तरीका है। यह हमेशा shboard.render.com पर ही रिक्वेस्ट भेजेगा।

            for (const key in params) {
                if (params[key] !== undefined && params[key] !== null) {
                    url += `&${key}=${encodeURIComponent(params[key])}`;
                }
            }
            
            console.log(`[API] सही सर्वर से डेटा लाया जा रहा है: ${url}`);

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error(`API Error for type ${type}:`, errorData);
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    data.items.forEach(item => {
                        const videoId = item.id?.videoId || item.id;
                        if (videoId && item.snippet) {
                            currentVideoCache.set(videoId, item);
                        }
                    });
                }
                
                return data;
            } catch (error) {
                console.error(`सर्वर से डेटा लाने में गंभीर त्रुटि (${type}):`, error);
                if (type === 'search') {
                     const grid = document.getElementById('long-video-grid');
                     if(grid) grid.innerHTML = '<p class="static-message">Could not load videos. Please check your connection or API key.</p>';
                     const carousel = document.getElementById('long-video-carousel-wrapper');
                     if(carousel) carousel.innerHTML = '<p class="static-message">Could not load trending videos.</p>';
                }
                return {
                    error: error.message,
                    items: [],
                    nextPageToken: null
                };
            }
        }
        
        function renderYouTubeLongVideos(videos, append = false) {
            const grid = document.getElementById('long-video-grid');
            const loadMoreBtn = document.getElementById('long-video-load-more-btn');
            if (!grid) return;

            if (!append) {
                grid.innerHTML = '';
            }

            if (videos.length === 0 && !append) {
                grid.innerHTML = '<p class="static-message">No videos found. Try a different search or category.</p>';
                if (loadMoreBtn) loadMoreBtn.style.display = 'none';
                return;
            }

            const fragment = document.createDocumentFragment();
            videos.forEach((video) => {
                if (!video.id || !video.id.kind || video.id.kind !== 'youtube#video') return;
                const card = createLongVideoCard(video);
                if (card) fragment.appendChild(card);
            });
            grid.appendChild(fragment);
            
            if (loadMoreBtn) {
                loadMoreBtn.style.display = appState.youtubeNextPageTokens.long ? 'block' : 'none';
                loadMoreBtn.disabled = false;
                loadMoreBtn.textContent = "Load More";
            }
        }

        async function loadMoreLongVideos() {
            const loadMoreBtn = document.getElementById('long-video-load-more-btn');
            if (!loadMoreBtn || loadMoreBtn.disabled) return;
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = "Loading...";

            const {
                type,
                value
            } = appState.longVideoSearchContext;
            
            // ★★★★★★★★★★ FIX #1 of 7 ★★★★★★★★★★
            // 'type: "video"' को हटाया गया
            const params = {
                pageToken: appState.youtubeNextPageTokens.long,
                videoDuration: 'long'
            };

            if (type === 'channel') {
                params.channelId = value;
            } else { 
                params.q = value;
            }

            const data = await fetchFromYouTubeAPI('search', params);

            appState.youtubeNextPageTokens.long = data.nextPageToken || null;
            if (data.items) {
                renderYouTubeLongVideos(data.items, true);
            }

            if (loadMoreBtn) {
                loadMoreBtn.disabled = false;
                loadMoreBtn.textContent = "Load More";
                if (!appState.youtubeNextPageTokens.long) {
                    loadMoreBtn.style.display = 'none';
                }
            }
        }

        async function playYouTubeVideoFromCard(videoId) {
            let video = currentVideoCache.get(videoId);
            if (!video) {
                console.warn("Video details not in cache for ID:", videoId, ". Fetching...");
                const data = await fetchFromYouTubeAPI('videoDetails', {
                    id: videoId
                });
                if (data.items && data.items[0]) {
                    video = data.items[0];
                    currentVideoCache.set(videoId, video);
                } else {
                    alert("Video details could not be loaded. Please try again.");
                    return;
                }
            }

            const channelId = video.snippet.channelId;

            navigateTo('creator-page-screen', {
                creatorId: channelId,
                startWith: 'play',
                videoId: videoId
            });
        }

        // =============================================================================
        // ★★★ YOUTUBE API INTEGRATION (REFACTORED & WITH FIREBASE CACHING) - END ★★★
        // =============================================================================

        // DOM Elements
        const appContainer = document.getElementById('app-container');
        const screens = document.querySelectorAll('.screen');
        const profileImageInput = document.getElementById('profile-image-input');
        const profileImagePreview = document.getElementById('profile-image-preview');
        const commentsModal = document.getElementById('comments-modal');
        const commentsList = document.getElementById('comments-list');
        const commentInput = document.getElementById('comment-input');
        const sendCommentBtn = document.getElementById('send-comment-btn');
        const videoSwiper = document.getElementById('video-swiper');
        const homeStaticMessageContainer = document.getElementById('home-static-message-container');
        const saveContinueBtn = document.getElementById('save-continue-btn');

        const categories = [
            "Trending", "Music", "Gaming", "Movies", "News", "Live", "Sports",
            "Learning", "Fashion & Beauty", "Comedy", "Entertainment", "Technology",
            "Cooking", "Travel", "Vlogs", "Podcasts", "Dance", "Animation",
            "Automotive", "Pets & Animals", "Science", "History", "Documentary",
            "DIY", "Health & Fitness", "Finance", "Real Estate", "Astrology",
            "Spirituality", "Motivation", "Bhakti", "Bollywood News", "Tollywood",
            "Kollywood", "Sandalwood", "Art & Craft", "Booktubers"
        ];
        const diverseTopics = [
            "latest movie trailers", "viral internet moments", "new tech gadgets 2025",
            "stand up comedy india", "amazing science experiments", "top music hits 2025",
            "travel vlogs Europe", "indian street food tour", "DIY home decor low cost",
            "cricket highlights today", "BGMI gameplay", "political debate india",
            "easy dinner recipes", "stock market analysis", "yoga for beginners",
            "hindi web series review", "celebrity interviews", "unboxing new phone",
            "ghost stories in hindi", "motivational speech sandeep maheshwari"
        ];

        function getRandomTopic() {
            return diverseTopics[Math.floor(Math.random() * diverseTopics.length)];
        }

        function activateScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.style.display = 'none';
                screen.classList.remove('active');
            });
            const activeScreen = document.getElementById(screenId);
            if (activeScreen) {
                activeScreen.style.display = 'flex';
                setTimeout(() => activeScreen.classList.add('active'), 10);
            }
            appState.currentScreen = screenId;
        }

        function navigateTo(nextScreenId, payload = null) {
            if (appState.currentScreen === nextScreenId && JSON.stringify(appState.currentScreenPayload) === JSON.stringify(payload) && nextScreenId !== 'creator-page-screen') return;

            if (nextScreenId !== 'splash-screen' && nextScreenId !== 'information-screen') {
                localStorage.setItem('shubhzone_lastScreen', nextScreenId);
            }

            if (appState.navigationStack[appState.navigationStack.length - 1] !== nextScreenId) {
                appState.navigationStack.push(nextScreenId);
            }

            if (appState.currentScreen === 'home-screen' && activePlayerId && players[activePlayerId]) {
                pauseActivePlayer();
            }
            if (appState.currentScreen === 'creator-page-screen') {
                if (appState.creatorPagePlayers.long) {
                    appState.creatorPagePlayers.long.destroy();
                    appState.creatorPagePlayers.long = null;
                }
                const creatorContent = document.getElementById('creator-page-content');
                if (creatorContent) creatorContent.innerHTML = '';
                document.getElementById('app-container').classList.remove('fullscreen-active');
            }
            activePlayerId = null;

            appState.currentScreenPayload = payload;
            activateScreen(nextScreenId);
            
            // Initialize screen-specific logic
            if (nextScreenId === 'profile-screen') loadUserVideosFromFirebase();
            if (nextScreenId === 'long-video-screen') setupLongVideoScreen();
            if (nextScreenId === 'history-screen') initializeHistoryScreen();
            if (nextScreenId === 'home-screen') setupShortsScreen();
            if (nextScreenId === 'creator-page-screen' && payload && payload.creatorId) {
                initializeCreatorPage(payload);
            }
            if (nextScreenId === 'friends-screen') {
                populateAddFriendsList();
                populateFriendRequestsList();
                populateMembersList();
            }
        }

        function navigateBack() {
            if (appState.currentScreen === 'creator-page-screen') {
                if (appState.creatorPagePlayers.long) {
                    appState.creatorPagePlayers.long.destroy();
                    appState.creatorPagePlayers.long = null;
                }
                document.getElementById('app-container').classList.remove('fullscreen-active');
            }

            if (appState.navigationStack.length <= 1) {
                navigateTo('main-home-screen'); // वापस होम पर जाएं
                return;
            }

            appState.navigationStack.pop();

            const previousScreenId = appState.navigationStack[appState.navigationStack.length - 1] || 'main-home-screen';

            navigateTo(previousScreenId, null);
        }

        async function checkUserProfileAndProceed(user) {
            if (!user) return;
            appState.currentUser.uid = user.uid;
            const userRef = db.collection('users').doc(user.uid);
            const doc = await userRef.get();

            if (doc.exists) {
                let userData = doc.data();

                if (!userData.referralCode || !userData.referralCode.startsWith('@')) {
                    userData.referralCode = await generateAndSaveReferralCode(user.uid, userData.name);
                }
                userData.friends = userData.friends || [];
                appState.currentUser = { ...appState.currentUser,
                    ...userData
                };

                const savedChannels = localStorage.getItem('shubhzone_addedChannels');
                appState.currentUser.addedChannels = savedChannels ? JSON.parse(savedChannels) : [];

                const savedHistory = localStorage.getItem('shubhzoneViewingHistory');
                if (savedHistory) {
                    appState.viewingHistory = JSON.parse(savedHistory);
                }
                updateProfileUI();

                if (userData.name && userData.state) {
                    await startAppLogic();
                } else {
                    navigateTo('information-screen');
                }

            } else {
                const initialData = {
                    uid: user.uid,
                    name: '',
                    email: user.email || '',
                    avatar: user.photoURL || 'https://via.placeholder.com/120/222/FFFFFF?text=+',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    friends: [],
                    referralCode: await generateAndSaveReferralCode(user.uid, user.displayName || 'user'),
                    isReferred: false,
                };
                await userRef.set(initialData);
                appState.currentUser = { ...appState.currentUser,
                    ...initialData
                };
                updateProfileUI();
                navigateTo('information-screen');
            }
        }

        let appInitializationComplete = false;

        function initializeApp() {
            if (appInitializationComplete) return;
            appInitializationComplete = true;

            document.querySelectorAll('.nav-item[data-nav="profile"]').forEach(item => item.style.display = 'none');

            auth.onAuthStateChanged(user => {
                if (user) {
                    checkUserProfileAndProceed(user);
                } else {
                    auth.signInAnonymously().catch(error => console.error("Anonymous sign-in failed:", error));
                }
            });

            activateScreen('splash-screen');
        }

        function loadUserVideosFromFirebase() {
            renderUserProfileVideos();
        }

        function updateNavActiveState(activeNav) {
            document.querySelectorAll('.bottom-nav').forEach(navBar => {
                navBar.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                const currentItem = navBar.querySelector(`.nav-item[data-nav="${activeNav}"]`);
                if (currentItem) currentItem.classList.add('active');
            });
        }

        profileImageInput.addEventListener('change', function() {
            if (this.files[0]) {
                const reader = new FileReader();
                reader.onload = e => profileImagePreview.src = e.target.result;
                reader.readAsDataURL(this.files[0]);
            }
        });

        function checkCustom(select, inputId) {
            document.getElementById(inputId).style.display = select.value === 'custom' ? 'block' : 'none';
        }

        async function saveAndContinue() {
            saveContinueBtn.disabled = true;
            saveContinueBtn.textContent = 'Saving...';

            const name = document.getElementById('info-name').value.trim();
            const stateValue = document.getElementById('info-state').value;
            const customState = document.getElementById('custom-state-input').value.trim();
            const state = stateValue === 'custom' ? customState : stateValue;
            const referralCodeInput = document.getElementById('info-referral').value.trim();

            if (!name || !state) {
                alert('Please enter your name and select your state.');
                saveContinueBtn.disabled = false;
                saveContinueBtn.textContent = 'Continue';
                return;
            }

            const userData = {
                name,
                mobile: document.getElementById('info-mobile').value.trim(),
                email: document.getElementById('info-email').value.trim(),
                address: document.getElementById('info-address').value.trim(),
                hobby: document.getElementById('info-hobby').value.trim(),
                state: state,
                country: document.getElementById('info-country').value === 'custom' ? document.getElementById('custom-country-input').value.trim() : document.getElementById('info-country').value
            };

            if (referralCodeInput) {
                const referringUser = await processReferral(referralCodeInput, appState.currentUser.uid);
                if (referringUser) {
                    userData.isReferred = true;
                    userData.referredBy = referringUser.uid;
                } else {
                    alert("Invalid referral code. Continuing without it.");
                }
            }

            const file = profileImageInput.files[0];
            if (file) {
                try {
                    const storageRef = storage.ref(`avatars/${appState.currentUser.uid}/${file.name}`);
                    const snapshot = await storageRef.put(file);
                    userData.avatar = await snapshot.ref.getDownloadURL();
                } catch (error) {
                    console.error("Avatar upload error:", error);
                    alert("Failed to upload profile picture.");
                    saveContinueBtn.disabled = false;
                    saveContinueBtn.textContent = 'Continue';
                    return;
                }
            }

            try {
                await db.collection('users').doc(appState.currentUser.uid).set(userData, {
                    merge: true
                });

                const userDoc = await db.collection('users').doc(appState.currentUser.uid).get();
                if (!userDoc.data().referralCode) {
                    await generateAndSaveReferralCode(appState.currentUser.uid, name);
                }

                const refreshedUserData = (await db.collection('users').doc(appState.currentUser.uid).get()).data();
                appState.currentUser = { ...appState.currentUser,
                    ...refreshedUserData
                };

                updateProfileUI();
                await startAppLogic();
            } catch (error) {
                console.error("Profile save error:", error);
                alert("Failed to save profile.");
                saveContinueBtn.disabled = false;
                saveContinueBtn.textContent = 'Continue';
            }
        }

        function updateProfileUI() {
            const profileHeaderAvatar = document.getElementById('profile-header-avatar');
            if (profileHeaderAvatar) profileHeaderAvatar.src = appState.currentUser.avatar || "https://via.placeholder.com/50/222/FFFFFF?text=+";
            profileImagePreview.src = appState.currentUser.avatar || "https://via.placeholder.com/120/222/FFFFFF?text=+";
            document.getElementById('info-name').value = appState.currentUser.name || '';
            document.getElementById('info-mobile').value = appState.currentUser.mobile || '';
            document.getElementById('info-email').value = appState.currentUser.email || '';
            document.getElementById('info-address').value = appState.currentUser.address || '';
            document.getElementById('info-hobby').value = appState.currentUser.hobby || '';
            document.getElementById('info-state').value = appState.currentUser.state || '';
            document.getElementById('info-country').value = appState.currentUser.country || 'India';
        }

        let appStartLogicHasRun = false;
        const startAppLogic = async () => {
            if (!appState.currentUser || !appState.currentUser.uid) {
                console.warn("User data not ready yet, retrying in 100ms...");
                setTimeout(startAppLogic, 100);
                return;
            }

            if (appStartLogicHasRun && appState.currentScreen !== 'splash-screen' && appState.currentScreen !== 'information-screen') {
                return;
            }
            appStartLogicHasRun = true;
            console.log("Starting main app logic...");

            const getStartedBtn = document.getElementById('get-started-btn');
            const loadingContainer = document.getElementById('loading-container');
            if (getStartedBtn) getStartedBtn.style.display = 'none';
            if (loadingContainer) loadingContainer.style.display = 'flex';

            try {
                const screenToNavigate = 'main-home-screen';
                navigateTo(screenToNavigate);
                updateNavActiveState('home');

            } catch (error) {
                console.error("CRITICAL ERROR during app start:", error);
                alert("Could not start the app. Please check your connection and try again.");
                if (loadingContainer) loadingContainer.innerHTML = '<p style="color: var(--error-red);">App failed to start.</p>';
            }
        };

        function renderVideoSwiper(videos, append = false) {
            if (!videoSwiper) return;

            if (!append) {
                videoSwiper.innerHTML = '';
                Object.values(players).forEach(player => {
                    if (player && typeof player.destroy === 'function') player.destroy();
                });
                players = {};
                if (videoObserver) videoObserver.disconnect();
                setupVideoObserver();
            }

            if (!videos || videos.length === 0) {
                if (!append) {
                    if (homeStaticMessageContainer) {
                        homeStaticMessageContainer.querySelector('.static-message').textContent = 'No shorts found for this category.';
                        videoSwiper.appendChild(homeStaticMessageContainer);
                        homeStaticMessageContainer.style.display = 'flex';
                    }
                }
                return;
            }

            if (homeStaticMessageContainer) {
                homeStaticMessageContainer.style.display = 'none';
            }

            const fragment = document.createDocumentFragment();
            videos.forEach((video) => {
                if (!video.id || !video.id.kind || video.id.kind !== 'youtube#video') return;
                const videoId = video.id?.videoId || video.id;
                if (!videoId) return;

                const slide = document.createElement('div');
                slide.className = 'video-slide';
                slide.dataset.videoId = videoId;
                slide.dataset.channelId = video.snippet.channelId;

                slide.addEventListener('click', (e) => {
                    if (e.target.closest('.video-meta-overlay')) return;
                    togglePlayPause(videoId);
                });

                const playerHtml = `<div class="player-container" id="player-${videoId}"></div>`;
                const thumbnailUrl = video.snippet.thumbnails.high?.url || video.snippet.thumbnails.medium?.url;
                const uploaderName = video.snippet.channelTitle;
                const uploaderAvatar = 'https://via.placeholder.com/40';
                const title = video.snippet.title;

                const creatorProfileOnClick = `navigateTo('creator-page-screen', { creatorId: '${video.snippet.channelId}', startWith: 'home' })`;
                const addChannelOnClick = `addChannelToList(event, '${video.snippet.channelId}')`;

                slide.innerHTML = `
                    <div class="video-preloader" style="background-image: url('${thumbnailUrl}');"><div class="loader"></div></div>
                    ${playerHtml}
                    <div class="video-meta-overlay">
                        <div class="uploader-info" onclick="${creatorProfileOnClick}"><img src="${uploaderAvatar}" class="uploader-avatar"><span class="uploader-name">${escapeHTML(uploaderName)}</span></div>
                        <p class="video-title">${escapeHTML(title)}</p>
                        <button class="add-channel-btn haptic-trigger" onclick="${addChannelOnClick}"><i class="fas fa-plus"></i> Add</button>
                    </div>
                `;
                fragment.appendChild(slide);
                videoObserver.observe(slide);
            });
            videoSwiper.appendChild(fragment);

            const oldTrigger = document.getElementById('shorts-load-more-trigger');
            if (oldTrigger) oldTrigger.remove();

            if (appState.youtubeNextPageTokens.shorts) {
                const trigger = document.createElement('div');
                trigger.id = 'shorts-load-more-trigger';
                trigger.innerHTML = `<div class="loader-container" style="padding: 20px 0;"><div class="loader"></div></div>`;
                videoSwiper.appendChild(trigger);
                videoObserver.observe(trigger);
            }
        }

        function onPlayerError(event) {
            const videoId = event.target.getVideoData().video_id;
            console.error(`[YT Player Error] Video ID: ${videoId}, Error Code: ${event.data}`);
            
            const iframe = event.target.getIframe();
            if (iframe && iframe.parentElement) {
                const container = iframe.parentElement;
                container.innerHTML = `<div style="color:white; text-align:center; padding: 20px; font-size: 1.1em; display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%;">
                    <p>Could Not Play Video</p>
                    <p style="font-size:0.8em; color: #aaa;">(Error Code: ${event.data})</p>
                </div>`;
            }
        }

        function onYouTubeIframeAPIReady() {
            console.log("[YT API] YouTube IFrame API is ready.");
            isYouTubeApiReady = true;

            console.log(`[YT API] Processing ${youtubePlayerQueue.length} queued player requests.`);
            youtubePlayerQueue.forEach(request => {
                console.log(`[YT API] Creating queued player for container: ${request.containerId}`);
                if (request.type === 'shorts') {
                    createPlayerForSlide(request.slide, true);
                } else if (request.type === 'long') {
                    initializeCreatorPagePlayer(request.videoId, request.containerId, 'long', true);
                }
            });
            youtubePlayerQueue = [];
        }

        function onPlayerReady(event) {
            const iframe = event.target.getIframe();
            const videoId = event.target.getVideoData().video_id;
            console.log(`[YT Player] Player ready for video ID: ${videoId}`);
            const slide = iframe.closest('.video-slide');
            if (slide) {
                const preloader = slide.querySelector('.video-preloader');
                if (preloader) preloader.style.display = 'none';
            }
            if (userHasInteracted) {
                event.target.unMute();
            }
        }

        function onPlayerStateChange(event) {
            const iframe = event.target.getIframe();
            if (!iframe) return;
            const isCreatorPlayer = iframe.id === 'creator-page-player-long';
            if (isCreatorPlayer) {
                handleCreatorPlayerStateChange(event);
            }
        }

        function addVideoToHistory(videoData) {
            if (!videoData || !videoData.id) return;
            const videoId = videoData.id.videoId || videoData.id;

            const historyItem = {
                id: videoId,
                watchedAt: new Date().toISOString(),
                title: videoData.snippet.title,
                channelTitle: videoData.snippet.channelTitle,
                channelId: videoData.snippet.channelId,
                thumbnailUrl: videoData.snippet.thumbnails.medium.url,
                videoLengthType: 'short'
            };

            const existingIndex = appState.viewingHistory.findIndex(item => item.id === videoId);
            if (existingIndex > -1) appState.viewingHistory.splice(existingIndex, 1);
            appState.viewingHistory.unshift(historyItem);
            if (appState.viewingHistory.length > 100) appState.viewingHistory.pop();
            localStorage.setItem('shubhzoneViewingHistory', JSON.stringify(appState.viewingHistory));
        }

        function addLongVideoToHistory(videoData) {
            if (!videoData || !videoData.id) return;
            const videoId = videoData.id.videoId || videoData.id;
            const historyItem = {
                id: videoId,
                watchedAt: new Date().toISOString(),
                title: videoData.snippet.title,
                channelTitle: videoData.snippet.channelTitle,
                channelId: videoData.snippet.channelId,
                thumbnailUrl: videoData.snippet.thumbnails.medium.url,
                videoLengthType: 'long'
            };
            const existingIndex = appState.viewingHistory.findIndex(item => item.id === videoId);
            if (existingIndex > -1) appState.viewingHistory.splice(existingIndex, 1);
            appState.viewingHistory.unshift(historyItem);
            if (appState.viewingHistory.length > 100) appState.viewingHistory.pop();
            localStorage.setItem('shubhzoneViewingHistory', JSON.stringify(appState.viewingHistory));
        }

        function togglePlayPause(videoId) {
            const player = players[videoId];
            if (!player || typeof player.getPlayerState !== 'function') return;
            const state = player.getPlayerState();
            if (state === YT.PlayerState.PLAYING || state === YT.PlayerState.BUFFERING) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }

        function playActivePlayer(videoId) {
            if (!videoId) return;
            if (activePlayerId && activePlayerId !== videoId) {
                pauseActivePlayer();
            }
            activePlayerId = videoId;
            const videoData = currentVideoCache.get(videoId);
            if (videoData) addVideoToHistory(videoData);

            const player = players[videoId];
            if (!player || typeof player.playVideo !== 'function' || !player.getIframe() || !document.body.contains(player.getIframe())) {
                const slide = document.querySelector(`.video-slide[data-video-id="${videoId}"]`);
                if (slide) createPlayerForSlide(slide);
                return;
            }

            player.unMute();
            player.playVideo();
        }

        function pauseActivePlayer() {
            if (!activePlayerId) return;
            const player = players[activePlayerId];
            if (player && typeof player.pauseVideo === 'function') {
                if (player.getPlayerState() === YT.PlayerState.PLAYING || player.getPlayerState() === YT.PlayerState.BUFFERING) {
                    player.pauseVideo();
                }
            }
        }

        function createPlayerForSlide(slide, forceCreation = false) {
            const videoId = slide.dataset.videoId;
            if (!isYouTubeApiReady && !forceCreation) {
                console.log(`[YT Player] API not ready. Queuing player for video ID: ${videoId}`);
                if (!youtubePlayerQueue.some(item => item.videoId === videoId)) {
                    youtubePlayerQueue.push({
                        type: 'shorts',
                        slide: slide,
                        videoId: videoId
                    });
                }
                return;
            }


            if (players[videoId]) {
                if (typeof players[videoId].playVideo === 'function') {
                    console.log(`[YT Player] Player for ${videoId} already exists. Playing.`);
                    playActivePlayer(videoId);
                }
                return;
            }

            const playerId = `player-${videoId}`;
            const playerElement = document.getElementById(playerId);
            if (!playerElement || playerElement.tagName === 'IFRAME') return;

            console.log(`[YT Player] Creating new shorts player for video ID: ${videoId}`);
            players[videoId] = new YT.Player(playerId, {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'autoplay': 0,
                    'controls': 0,
                    'mute': userHasInteracted ? 0 : 1,
                    'rel': 0,
                    'showinfo': 0,
                    'modestbranding': 1,
                    'loop': 1,
                    'playlist': videoId,
                    'fs': 0,
                    'iv_load_policy': 3,
                    'origin': window.location.origin
                },
                events: {
                    'onReady': (event) => {
                        onPlayerReady(event);
                        const slideRect = slide.getBoundingClientRect();
                        const isInView = slideRect.top >= 0 && slideRect.bottom <= window.innerHeight;
                        if (isInView) {
                            playActivePlayer(videoId);
                        }
                    },
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function setupVideoObserver() {
            if (videoObserver) videoObserver.disconnect();
            if (!videoSwiper) return;
            const options = {
                root: videoSwiper,
                threshold: 0.8
            };
            videoObserver = new IntersectionObserver(async (entries) => {
                for (const entry of entries) {
                    if (entry.target.id === 'shorts-load-more-trigger') {
                        if (entry.isIntersecting) {
                            videoObserver.unobserve(entry.target);
                            await loadMoreShorts();
                        }
                        continue;
                    }
                    if (entry.target.classList.contains('native-ad-slide')) continue;
                    const videoId = entry.target.dataset.videoId;
                    if (!videoId) continue;

                    if (entry.isIntersecting) {
                        playActivePlayer(videoId);
                    } else {
                        if (videoId === activePlayerId) {
                            pauseActivePlayer();
                            activePlayerId = null;
                        }
                    }
                }
            }, options);
        }

        function logoutUser() {
            if (confirm("Are you sure you want to log out?")) {
                localStorage.clear();
                auth.signOut().then(() => {
                    window.location.reload();
                }).catch(error => {
                    console.error("Logout failed:", error);
                    alert("Logout failed.");
                });
            }
        }

        function renderCategoriesInBar() {
            const scroller = document.getElementById('category-scroller');
            const longScroller = document.getElementById('long-video-category-scroller');
            [scroller, longScroller].forEach(s => {
                if (!s) return;
                s.innerHTML = '';
                const allChip = document.createElement('div');
                allChip.className = 'category-chip active haptic-trigger';
                allChip.textContent = 'All';
                allChip.dataset.category = "All";
                allChip.onclick = () => filterVideosByCategory(s.id, 'All', allChip);
                s.appendChild(allChip);
                categories.forEach(category => {
                    const chip = document.createElement('div');
                    chip.className = 'category-chip haptic-trigger';
                    chip.textContent = category;
                    chip.dataset.category = category;
                    chip.onclick = () => filterVideosByCategory(s.id, category, chip);
                    s.appendChild(chip);
                });
            });
        }

        function filterVideosByCategory(scrollerId, category, element) {
            const scroller = document.getElementById(scrollerId);
            if (!scroller) return;
            scroller.querySelectorAll('.category-chip').forEach(chip => chip.classList.remove('active'));
            if (element) element.classList.add('active');

            const searchInput = document.getElementById('long-video-search-input');
            if (searchInput) searchInput.value = '';

            if (scrollerId === 'category-scroller') {
                if (activePlayerId) pauseActivePlayer();
                activePlayerId = null;
                setupShortsScreen(category);
            } else {
                populateLongVideoGrid(category);
            }
        }

        function renderUserProfileVideos() {
            const shortGrid = document.getElementById('user-short-video-grid');
            const longGrid = document.getElementById('user-long-video-grid');
            const message = '<p class="static-message" style="color: var(--text-secondary); grid-column: 1 / -1;">Video uploads are no longer supported. All content is from YouTube.</p>';
            if (shortGrid) shortGrid.innerHTML = message;
            if (longGrid) longGrid.innerHTML = message;
        }

        async function setupShortsScreen(category = 'All') {
            const query = category.toLowerCase() === 'trending' ? 'trending shorts india' : (category.toLowerCase() === 'all' ? getRandomTopic() + ' shorts' : `${category} shorts`);
            if (homeStaticMessageContainer) {
                videoSwiper.innerHTML = '';
                videoSwiper.appendChild(homeStaticMessageContainer);
                homeStaticMessageContainer.style.display = 'flex';
                homeStaticMessageContainer.querySelector('.static-message').innerHTML = '<div class="loader"></div>'; // सिर्फ लोडर दिखाएं
            }

            // ★★★★★★★★★★ FIX #2 of 7 ★★★★★★★★★★
            // 'type: "video"' को हटाया गया
            const data = await fetchFromYouTubeAPI('search', {
                q: query,
                videoDuration: 'short'
            });
            appState.youtubeNextPageTokens.shorts = data.nextPageToken || null;
            if (data.items && data.items.length > 0) {
                renderVideoSwiper(data.items, false);
            } else {
                renderVideoSwiper([], false);
            }
        }

        async function loadMoreShorts() {
            const activeCategoryChip = document.querySelector('#category-scroller .category-chip.active');
            const category = activeCategoryChip ? activeCategoryChip.dataset.category : 'All';
            const query = category.toLowerCase() === 'trending' ? 'trending shorts india' : (category.toLowerCase() === 'all' ? getRandomTopic() + ' shorts' : `${category} shorts`);
            
            // ★★★★★★★★★★ FIX #3 of 7 ★★★★★★★★★★
            // 'type: "video"' को हटाया गया
            const data = await fetchFromYouTubeAPI('search', {
                q: query,
                videoDuration: 'short',
                pageToken: appState.youtubeNextPageTokens.shorts
            });

            appState.youtubeNextPageTokens.shorts = data.nextPageToken || null;
            if (data.items) {
                renderVideoSwiper(data.items, true);
            }
        }

        async function setupLongVideoScreen() {
            renderCategoriesInBar();
            await renderTrendingCarousel();
            await populateLongVideoGrid('Trending');
            const gridContainer = document.querySelector('.long-video-screen-content');
            let loadMoreBtn = document.getElementById('long-video-load-more-btn');
            if (!loadMoreBtn && gridContainer) {
                loadMoreBtn = document.createElement('button');
                loadMoreBtn.id = 'long-video-load-more-btn';
                loadMoreBtn.className = 'haptic-trigger';
                loadMoreBtn.textContent = 'Load More';
                loadMoreBtn.style.display = 'none';
                loadMoreBtn.onclick = loadMoreLongVideos;
                gridContainer.appendChild(loadMoreBtn);
            }
        }

        async function populateLongVideoGrid(category = 'All') {
            const grid = document.getElementById('long-video-grid');
            if (!grid) return;
            grid.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';
            let query;
            if (category.toLowerCase() === 'trending') {
                query = 'trending videos';
            } else {
                query = category.toLowerCase() === 'all' ? getRandomTopic() : category;
            }

            appState.longVideoSearchContext = {
                type: 'query',
                value: query
            };

            // ★★★★★★★★★★ FIX #4 of 7 ★★★★★★★★★★
            // 'type: "video"' को हटाया गया
            const data = await fetchFromYouTubeAPI('search', {
                q: query,
                videoDuration: 'long'
            });

            appState.youtubeNextPageTokens.long = data.nextPageToken || null;
            renderYouTubeLongVideos(data.items || [], false);
        }

        async function renderTrendingCarousel() {
            const carouselWrapper = document.getElementById('long-video-carousel-wrapper');
            if (!carouselWrapper) return;
            carouselWrapper.innerHTML = `<div class="loader-container"><div class="loader"></div></div>`;
            
            // ★★★★★★★★★★ FIX #5 of 7 ★★★★★★★★★★
            // 'type: "video"' को हटाया गया
            const data = await fetchFromYouTubeAPI('search', {
                q: 'latest trending videos',
                videoDuration: 'long',
                maxResults: 10
            });

            if (data.items && data.items.length > 0) {
                carouselWrapper.innerHTML = data.items.map(video => {
                    const videoId = video.id?.videoId || video.id;
                    const thumbnailUrl = video.snippet.thumbnails.high?.url || video.snippet.thumbnails.medium?.url;
                    return `
                        <div class="carousel-card haptic-trigger" 
                             style="background-image: url('${escapeHTML(thumbnailUrl)}')"
                             onclick="playYouTubeVideoFromCard('${videoId}')">
                        </div>
                    `;
                }).join('');
            } else {
                carouselWrapper.innerHTML = `<p class="static-message">Could not load trending videos.</p>`;
            }
        }

        async function performLongVideoSearch() {
            const input = document.getElementById('long-video-search-input');
            let query = input.value.trim();
            if (!query) return;

            const videoIdFromUrl = extractYouTubeId(query);
            if (videoIdFromUrl) {
                playYouTubeVideoFromCard(videoIdFromUrl);
                return;
            }

            document.querySelectorAll('#long-video-category-scroller .category-chip').forEach(chip => chip.classList.remove('active'));

            const grid = document.getElementById('long-video-grid');
            if (!grid) return;
            grid.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';

            // ★★★★★★★★★★ FIX #6 of 7 ★★★★★★★★★★
            // 'type: "video"' को हटाया गया
            let searchParams = {
                videoDuration: 'long'
            };
            let finalData;

            try {
                const channelData = await fetchFromYouTubeAPI('search', {
                    q: query,
                    type: 'channel',
                    maxResults: 1
                });
                let channelId = null;
                if (channelData.items && channelData.items.length > 0) {
                    const channelTitle = channelData.items[0].snippet.title.toLowerCase();
                    const queryLower = query.toLowerCase();
                    if (channelTitle.includes(queryLower)) {
                        channelId = channelData.items[0].id.channelId;
                    }
                }

                if (channelId) {
                    console.log(`Channel found: ${channelId}. Searching for videos in this channel.`);
                    searchParams.channelId = channelId;
                    appState.longVideoSearchContext = {
                        type: 'channel',
                        value: channelId
                    };
                } else {
                    console.log(`No specific channel found. Performing general search for: ${query}`);
                    searchParams.q = query;
                    appState.longVideoSearchContext = {
                        type: 'query',
                        value: query
                    };
                }

                finalData = await fetchFromYouTubeAPI('search', searchParams);

            } catch (error) {
                console.error("Error during search process:", error);
                finalData = {
                    items: [],
                    nextPageToken: null
                };
                grid.innerHTML = '<p class="static-message">An error occurred during search.</p>';
            }

            appState.youtubeNextPageTokens.long = finalData.nextPageToken || null;
            renderYouTubeLongVideos(finalData.items || [], false);
        }

        function createLongVideoCard(video) {
            const videoId = video.id?.videoId || video.id;
            if (!videoId || !video.snippet) return null;

            const card = document.createElement('div');
            card.className = 'long-video-card';
            card.dataset.videoId = videoId;
            card.dataset.channelId = video.snippet.channelId;

            const thumbnailUrl = video.snippet.thumbnails.high?.url || video.snippet.thumbnails.medium?.url;
            const addChannelOnClick = `addChannelToList(event, '${video.snippet.channelId}')`;

            card.innerHTML = `
                <div class="long-video-thumbnail" style="background-image: url('${escapeHTML(thumbnailUrl)}')" onclick="playYouTubeVideoFromCard('${videoId}')">
                    <i class="fas fa-play play-icon-overlay"></i>
                </div>
                <div class="long-video-info-container">
                    <div class="long-video-details" onclick="navigateTo('creator-page-screen', { creatorId: '${video.snippet.channelId}', startWith: 'home' })">
                        <span class="long-video-name">${escapeHTML(video.snippet.title)}</span>
                        <span class="long-video-uploader">${escapeHTML(video.snippet.channelTitle)}</span>
                    </div>
                </div>
                <button class="add-channel-btn-long-grid haptic-trigger" onclick="${addChannelOnClick}"><i class="fas fa-plus"></i> Add Channel</button>
            `;
            return card;
        }

        function initializeHistoryScreen() {
            const clearButton = document.getElementById('history-date-button');
            if (clearButton) {
                clearButton.innerHTML = `<i class="fas fa-trash-alt"></i> Clear All`;
                clearButton.onclick = clearAllHistory;
            }
            appState.viewingHistory = JSON.parse(localStorage.getItem('shubhzoneViewingHistory') || '[]');
            renderHistoryShortsScroller();
            renderHistoryLongVideoList();
        }

        function renderHistoryShortsScroller() { /* Unchanged */ }

        function renderHistoryLongVideoList() { /* Unchanged */ }

        function clearAllHistory() { /* Unchanged */ }

        function deleteFromHistory(videoId) { /* Unchanged */ }

        async function populateAddFriendsList(featuredUser = null) {
            const userListContainer = document.getElementById('add-friend-user-list');
            if (!userListContainer) return;
            userListContainer.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';
            try {
                const querySnapshot = await db.collection('users').get();
                const users = [];
                querySnapshot.forEach(doc => {
                    if (doc.id !== appState.currentUser.uid) {
                        users.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    }
                });

                if (users.length === 0) {
                    userListContainer.innerHTML = '<p class="static-message">No other users found to add.</p>';
                    return;
                }

                userListContainer.innerHTML = users.map(user => {
                    const isFriend = appState.currentUser.friends.includes(user.id);
                    const buttonHtml = isFriend ?
                        `<button class="add-button requested" disabled>Friends</button>` :
                        `<button class="add-button" onclick="sendFriendRequest('${user.id}', this)">Add</button>`;

                    return `
                        <div class="holographic-card">
                            <div class="profile-pic" onclick="showEnlargedImage('${user.avatar}')">
                                <img src="${user.avatar || 'https://via.placeholder.com/50'}" alt="Profile Pic">
                            </div>
                            <div class="info">
                                <div class="name">${escapeHTML(user.name || 'Unnamed User')}</div>
                                <div class="subtext">${escapeHTML(user.referralCode || '@' + user.id.substring(0,6))}</div>
                            </div>
                            ${buttonHtml}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error("Error fetching users:", error);
                userListContainer.innerHTML = '<p class="static-message">Could not load users. Please try again later.</p>';
            }
        }
        async function searchUser() { /* Unchanged */ }
        async function sendFriendRequest(receiverId, buttonElement) { /* Unchanged */ }
        async function populateFriendRequestsList() { /* Unchanged */ }
        async function acceptFriendRequest(event, requestId, senderId) { /* Unchanged */ }
        async function rejectFriendRequest(event, requestId) { /* Unchanged */ }
        async function populateMembersList() { /* Unchanged */ }
        async function startChat(friendId, friendName, friendAvatar) { /* Unchanged */ }
        async function sendMessage() { /* Unchanged */ }

        function loadChatMessages(chatId) { /* Unchanged */ }

        // =======================================================
        // ★★★ CREATOR PAGE LOGIC (REWORKED & FIXED) - START ★★★
        // =======================================================

        async function initializeCreatorPage(payload) {
            const {
                creatorId,
                startWith = 'home',
                videoId
            } = payload;
            appState.creatorPage.currentChannelId = creatorId;

            if (startWith === 'play' && videoId) {
                showCreatorPlayerView(videoId);
                return;
            }

            appState.creatorPage.currentView = 'channel';
            const creatorPageHeader = document.getElementById('creator-page-screen').querySelector('.screen-header');
            const creatorPageTabsContainer = document.getElementById('creator-page-tabs');
            const creatorPageContent = document.getElementById('creator-page-content');

            creatorPageHeader.style.display = 'flex';
            creatorPageTabsContainer.style.display = 'flex';
            creatorPageContent.innerHTML = '';
            creatorPageContent.classList.remove('player-active');

            creatorPageTabsContainer.innerHTML = `
                <button class="creator-page-tab-btn haptic-trigger" data-type="home">Home</button>
                <button class="creator-page-tab-btn haptic-trigger" data-type="videos">Videos</button>
                <button class="creator-page-tab-btn haptic-trigger" data-type="shorts">Shorts</button>
                <button class="creator-page-tab-btn haptic-trigger" data-type="playlists">Playlists</button>
            `;

            creatorPageTabsContainer.querySelectorAll('.creator-page-tab-btn').forEach(tab => {
                tab.addEventListener('click', () => {
                    creatorPageTabsContainer.querySelectorAll('.creator-page-tab-btn').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    loadCreatorPageContent({ ...payload,
                        startWith: tab.dataset.type,
                        videoId: null
                    });
                });
            });

            const effectiveStartWith = (startWith === 'videos') ? 'home' : startWith;
            const initialTab = creatorPageTabsContainer.querySelector(`.creator-page-tab-btn[data-type="${effectiveStartWith}"]`) || creatorPageTabsContainer.querySelector(`.creator-page-tab-btn[data-type="home"]`);
            if (initialTab) initialTab.classList.add('active');

            await loadCreatorPageContent({ ...payload,
                startWith: effectiveStartWith
            });
        }

        async function loadCreatorPageContent(payload) {
            const {
                creatorId,
                startWith,
                playlistId
            } = payload;
            const contentArea = document.getElementById('creator-page-content');
            contentArea.innerHTML = '<div class="loader-container" style="height: 100%;"><div class="loader"></div></div>';
            let data;
            switch (startWith) {
                case 'home':
                case 'videos':
                    // ★★★★★★★★★★ FIX #7 of 7 (part a) ★★★★★★★★★★
                    data = await fetchFromYouTubeAPI('search', {
                        channelId: creatorId,
                        order: 'date',
                        videoDuration: 'long'
                    });
                    renderCreatorVideoList(contentArea, data.items || [], 'long');
                    break;
                case 'shorts':
                    // ★★★★★★★★★★ FIX #7 of 7 (part b) ★★★★★★★★★★
                    data = await fetchFromYouTubeAPI('search', {
                        channelId: creatorId,
                        videoDuration: 'short',
                        order: 'date'
                    });
                    renderCreatorVideoList(contentArea, data.items || [], 'short');
                    break;
                case 'playlists':
                    data = await fetchFromYouTubeAPI('playlists', {
                        channelId: creatorId
                    });
                    renderCreatorPlaylistList(contentArea, data.items || [], payload);
                    break;
                case 'playlistItems':
                    data = await fetchFromYouTubeAPI('playlistItems', {
                        playlistId: playlistId
                    });
                    renderCreatorVideoList(contentArea, data.items || [], 'long');
                    break;
            }
        }

        function renderCreatorVideoList(container, videos, type) { /* Unchanged */ }

        function renderCreatorPlaylistList(container, playlists, payload) { /* Unchanged */ }

        function showCreatorPlayerView(videoId) {
            appState.creatorPage.currentView = 'player';
            const creatorPageScreen = document.getElementById('creator-page-screen');
            const contentArea = document.getElementById('creator-page-content');

            creatorPageScreen.querySelector('.screen-header').style.display = 'none';
            contentArea.classList.add('player-active');

            contentArea.innerHTML = `
                <div id="creator-page-player-container">
                     <div class="player-controls-header">
                        <div class="player-back-button haptic-trigger" onclick="navigateBack()">
                            <i class="fas fa-arrow-left"></i>
                        </div>
                        <div class="player-zoom-controls">
                            <button id="player-zoom-out-btn" class="haptic-trigger">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button id="player-zoom-in-btn" class="haptic-trigger">
                                <i class="fas fa-search-plus"></i>
                            </button>
                        </div>
                        <button id="player-rotate-btn" class="haptic-trigger">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="player-wrapper">
                        <div id="creator-page-player-long"></div>
                    </div>
                </div>
            `;

            initializeCreatorPagePlayer(videoId, 'creator-page-player-long', 'long');

            document.getElementById('player-rotate-btn').addEventListener('click', () => {
                document.getElementById('app-container').classList.toggle('fullscreen-active');
            });

            let currentZoom = 1.0;
            const playerWrapper = contentArea.querySelector('.player-wrapper');
            const zoomInBtn = document.getElementById('player-zoom-in-btn');
            const zoomOutBtn = document.getElementById('player-zoom-out-btn');

            zoomInBtn.addEventListener('click', () => {
                currentZoom = Math.min(2.5, currentZoom + 0.1);
                playerWrapper.style.transform = `scale(${currentZoom})`;
            });

            zoomOutBtn.addEventListener('click', () => {
                currentZoom = Math.max(0.5, currentZoom - 0.1);
                playerWrapper.style.transform = `scale(${currentZoom})`;
            });
        }

        function initializeCreatorPagePlayer(videoId, containerId, type, forceCreation = false) {
            if (appState.creatorPagePlayers[type]) {
                console.log(`[YT Player] Destroying existing creator player of type: ${type}`);
                appState.creatorPagePlayers[type].destroy();
                appState.creatorPagePlayers[type] = null;
            }

            const playerContainer = document.getElementById(containerId);

            if (!isYouTubeApiReady && !forceCreation) {
                console.log(`[YT Player] API not ready. Queuing creator player for video ID: ${videoId}`);
                youtubePlayerQueue.push({
                    type: 'long',
                    videoId: videoId,
                    containerId: containerId
                });
                return;
            }

            if (!playerContainer) {
                console.error(`[YT Player] Player container #${containerId} not found in DOM.`);
                return;
            }

            console.log(`[YT Player] Creating new creator player for video ID: ${videoId} in container: #${containerId}`);
            appState.creatorPagePlayers[type] = new YT.Player(containerId, {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'autoplay': 1,
                    'controls': 1,
                    'rel': 0,
                    'showinfo': 0,
                    'mute': 0,
                    'modestbranding': 1,
                    'fs': 0,
                    'origin': window.location.origin,
                    'iv_load_policy': 3
                },
                events: {
                    'onReady': (event) => {
                        console.log(`[YT Player] Creator player ready for video ID: ${videoId}`);
                        event.target.playVideo();
                        event.target.unMute();
                        const videoData = currentVideoCache.get(videoId);
                        if (videoData) {
                            addLongVideoToHistory(videoData);
                        }
                    },
                    'onStateChange': handleCreatorPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function handleCreatorPlayerStateChange(event) { /* Unchanged */ }

        // =======================================================
        // ★★★ CREATOR PAGE LOGIC (REWORKED & FIXED) - END ★★★
        // =======================================================


        async function addChannelToList(event, channelId) { /* Unchanged */ }

        function renderMyChannelsList() { /* Unchanged */ }

        function removeChannelFromList(event, channelId) { /* Unchanged */ }

        function provideHapticFeedback() { /* Unchanged */ }

        function loadHapticPreference() { /* Unchanged */ }

        function showEnlargedImage(imageUrl) { /* Unchanged */ }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.add('haptic-trigger');
                item.addEventListener('click', () => {
                    const targetNav = item.getAttribute('data-nav');
                    if (item.style.display === 'none') return;
                    let targetScreen;
                    
                    switch (targetNav) {
                        case 'home':
                            targetScreen = 'main-home-screen';
                            break;
                        case 'shorts':
                            targetScreen = 'home-screen';
                            break;
                        default:
                            targetScreen = `${targetNav}-screen`;
                    }

                    navigateTo(targetScreen);
                    updateNavActiveState(targetNav);
                });
            });

            initializeApp();

            document.getElementById('get-started-btn')?.addEventListener('click', () => {
                userHasInteracted = true;
                startAppLogic();
            });

            appContainer.addEventListener('click', (event) => {
                if (!userHasInteracted) {
                    userHasInteracted = true;
                    Object.values(players).forEach(p => p && typeof p.unMute === 'function' && p.unMute());
                    if (appState.creatorPagePlayers.long && typeof appState.creatorPagePlayers.long.unMute === 'function') {
                        appState.creatorPagePlayers.long.unMute();
                    }
                }
                if (event.target.closest('.haptic-trigger')) provideHapticFeedback();
            });

            document.getElementById('long-video-search-btn')?.addEventListener('click', performLongVideoSearch);
            document.getElementById('long-video-search-input')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performLongVideoSearch();
            });

            document.querySelector('#creator-page-screen .header-icon-left')?.addEventListener('click', () => navigateBack());
            initializeMessagingInterface();
            document.getElementById('add-friend-search-btn')?.addEventListener('click', searchUser);
            document.getElementById('add-friend-search-input')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchUser();
            });

            const openSidebar = () => {
                document.getElementById('main-sidebar').classList.add('open');
                document.getElementById('sidebar-overlay').classList.add('open');
            };
            document.getElementById('shorts-menu-icon')?.addEventListener('click', openSidebar);
            document.getElementById('long-video-menu-icon')?.addEventListener('click', openSidebar);

            const profileSidebarBtn = document.getElementById('sidebar-profile-btn');
            if (profileSidebarBtn) {
                profileSidebarBtn.addEventListener('click', () => {
                    navigateTo('profile-screen');
                    document.getElementById('main-sidebar').classList.remove('open');
                    document.getElementById('sidebar-overlay').classList.remove('open');
                });
            }

            document.getElementById('close-sidebar-btn')?.addEventListener('click', () => {
                document.getElementById('main-sidebar').classList.remove('open');
                document.getElementById('sidebar-overlay').classList.remove('open');
            });
            document.getElementById('sidebar-overlay')?.addEventListener('click', () => {
                document.getElementById('main-sidebar').classList.remove('open');
                document.getElementById('sidebar-overlay').classList.remove('open');
            });

            document.getElementById('long-video-history-btn')?.addEventListener('click', () => navigateTo('history-screen'));
            document.getElementById('back-from-history-btn')?.addEventListener('click', () => navigateBack());
            document.getElementById('profile-your-zone-btn')?.addEventListener('click', () => navigateTo('information-screen'));
            document.getElementById('profile-show-shorts-btn')?.addEventListener('click', () => toggleProfileVideoView('short'));
            document.getElementById('profile-show-longs-btn')?.addEventListener('click', () => toggleProfileVideoView('long'));

            const enlargeModal = document.getElementById('image-enlarge-modal');
            if (enlargeModal) enlargeModal.addEventListener('click', () => enlargeModal.classList.remove('active'));

            loadHapticPreference();

            document.querySelectorAll('#friends-screen .tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    document.querySelectorAll('#friends-screen .tab-content').forEach(content => content.classList.add('hidden'));
                    document.querySelectorAll('#friends-screen .tab-button').forEach(btn => btn.classList.remove('active'));
                    const contentToShow = document.getElementById(`${tabId}-content`);
                    if (contentToShow) contentToShow.classList.remove('hidden');
                    button.classList.add('active');
                });
            });
            
        });

        function initializeMessagingInterface() {
            const chatScreen = document.getElementById('chat-screen-overlay');
            if (!chatScreen) return;
            chatScreen.querySelector('.back-arrow')?.addEventListener('click', () => chatScreen.classList.remove('active'));
            const sendButton = chatScreen.querySelector('#send-button');
            const inputField = chatScreen.querySelector('.input-field');

            sendButton?.addEventListener('click', sendMessage);
            inputField?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            inputField?.addEventListener('input', () => {
                if (inputField.value.trim().length > 0) {
                    sendButton.classList.add('active');
                } else {
                    sendButton.classList.remove('active');
                }
            });
        }

        function toggleProfileVideoView(view) {
            const showShortsBtn = document.getElementById('profile-show-shorts-btn');
            const showLongsBtn = document.getElementById('profile-show-longs-btn');
            const shortGrid = document.getElementById('user-short-video-grid');
            const longGrid = document.getElementById('user-long-video-grid');
            if (!showShortsBtn || !showLongsBtn || !shortGrid || !longGrid) return;

            if (view === 'short') {
                showShortsBtn.classList.add('active');
                showLongsBtn.classList.remove('active');
                shortGrid.style.display = 'grid';
                longGrid.style.display = 'none';
            } else {
                showShortsBtn.classList.remove('active');
                showLongsBtn.classList.add('active');
                shortGrid.style.display = 'none';
                longGrid.style.display = 'grid';
            }
        }
        
        const setAppHeight = () => {
            const doc = document.documentElement;
            doc.style.setProperty('--app-height', `${window.innerHeight}px`);
        };
        window.addEventListener('resize', setAppHeight);
        setAppHeight();
    </script>
</body>

</html>
